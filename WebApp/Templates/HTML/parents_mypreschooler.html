<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preschooler Profile</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'media/PPMS-logo.png' %}">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
      font-size: 14px;
      font-weight: 400;
      background: url('{% static "media/loginbg.png" %}') center/cover no-repeat fixed;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .back-button {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 1000;
      background-color: #5bdab3;
      color: #1e1e2f;
      padding: 12px 20px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(91, 218, 179, 0.3);
    }

    .back-button:hover {
      background-color: #1565c0;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(21, 101, 192, 0.3);
    }

    .profile-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
    }

    .profile-container h2 {
      font-size: 18px;
      font-weight: 400;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Poppins', sans-serif;
      text-align: center;
    }

    .photo-box {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 1 / 1;
      background-color: #f0f0f0;
      overflow: hidden;
      position: relative;
      border: 2px dashed #ccc;
      border-radius: 8px;
      margin: 0 auto 20px auto;
    }

    .preschooler-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upload-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .file-input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 300px;
    }

    .file-input-native {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 10;
    }

    .file-input-button {
      background: linear-gradient(135deg, #5bdab3, #1565c0);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(91, 218, 179, 0.3);
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 45px;
    }

    .file-input-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
    }

    .file-input-button:active {
      transform: translateY(0);
    }

    .file-input-button.file-selected {
      background: linear-gradient(135deg, #4caf50, #2e7d32);
    }

    .file-name-display {
      font-size: 12px;
      color: #666;
      text-align: center;
      word-break: break-word;
      max-width: 100%;
    }

    .upload-button {
      background-color: #5bdab3;
      color: #1e1e2f;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(91, 218, 179, 0.3);
      opacity: 0.5;
      width: 100%;
      max-width: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .upload-button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .upload-button:not(:disabled) {
      opacity: 1;
    }

    .upload-button:not(:disabled):hover {
      background-color: #1565c0;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
    }

    .info p {
      margin-bottom: 10px;
      font-size: 14px;
      color: #333;
    }

    .info p strong {
      font-weight: 500;
    }

    .stat-box {
      background-color: #f4f6f8;
      border: 1px solid #e0e4e7;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      height: 100%;
    }

    .stat-box:hover {
      background-color: #1565c0;
      color: white;
      border-color: #1565c0;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(21, 101, 192, 0.3);
    }

    .stat-box .label {
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      color: inherit;
    }

    .stat-box .value {
      font-size: 16px;
      font-weight: 600;
      color: inherit;
    }

    .section-title {
      font-size: 16px;
      font-weight: 400;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      margin-bottom: 20px;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      background: white;
      position: relative;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: none;
      margin-bottom: 0;
      font-size: 14px;
    }

    .table th {
      background-color: #f8f9fa;
      color: #333;
      padding: 15px 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e9ecef;
    }

    .table td {
      border-bottom: 1px solid #e9ecef;
      padding: 15px 12px;
      text-align: center;
      font-size: 14px;
      color: #333;
      background: white;
      vertical-align: middle;
    }

    .table tr:hover td {
      background: #f8f9fa;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .status-completed {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      display: inline-block;
    }

    /* Mobile Responsive - Keep table format with horizontal scroll */
    @media (max-width: 1024px) {
      .main-container {
        margin: 0 10px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .table {
        min-width: 700px; /* Ensure minimum width for readability */
        margin-bottom: 0; /* Remove margin since container has it */
      }
    }

    

    @media (max-width: 576px) {
      body {
        padding: 10px;
      }

      .back-button {
        top: 15px;
        right: 15px;
        padding: 8px 12px;
        font-size: 12px;
      }

      .photo-box {
        max-width: 200px;
      }

      .section-title {
        font-size: 13px;
      }

      /* Maintain table with horizontal scroll */
      .table-container {
        margin-left: -10px;
        margin-right: -10px;
        border-radius: 0;
        width: calc(100% + 20px);
      }

      .table {
        min-width: 700px; /* Still force horizontal scroll */
        font-size: 11px;
      }

      .table th,
      .table td {
        padding: 8px 6px;
        min-width: 70px;
      }

      .table th:first-child,
      .table td:first-child {
        min-width: 120px; /* Adjust for smaller screens */
      }
    }

    @media (max-width: 480px) {
      .table-container {
        margin-left: -10px;
        margin-right: -10px;
        border-radius: 0;
        width: calc(100% + 20px);
      }

      .table {
        min-width: 600px; /* Minimum for very small screens */
        font-size: 10px;
      }

      .table th,
      .table td {
        padding: 6px 4px;
        min-width: 60px;
      }

      .table th:first-child,
      .table td:first-child {
        min-width: 100px;
      }
    }

    /* Add scroll indicator for better UX */
    .table-container::after {
      content: 'â†’ Scroll to see more';
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 11px;
      color: #666;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0.7;
      pointer-events: none;
    }

    @media (min-width: 769px) {
      .table-container::after {
        display: none;
      }
    }



    .info-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .info-section h3 {
      color: #333;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #5bdab3;
      padding-bottom: 8px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 0;
    }

    .info-label {
      font-weight: 500;
      color: #666;
      font-size: 14px;
    }

    .info-value {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      text-align: right;
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: none;
      margin-bottom: 0;
    }

    .info-table th {
      background-color: #f8f9fa;
      color: #333;
      padding: 15px 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e9ecef;
    }

    .info-table td {
      border-bottom: 1px solid #e9ecef;
      padding: 15px 12px;
      text-align: center;
      font-size: 14px;
      color: #333;
      background: white;
    }

    .info-table tr:hover td {
      background: #f8f9fa;
    }

    .info-table tr:last-child td {
      border-bottom: none;
    }

    .info-table th:last-child,
    .info-table td:last-child {
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .schedule-modal-card {
      max-width: 500px;
      width: 90%;
    }

    .schedule-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #ffffff;
      z-index: 1001;
    }

    .close-modal:hover {
      color: #000;
    }

    .schedule-close-modal {
      color: #333;
    }

    .schedule-close-modal:hover {
      color: #666;
    }

    /* Vaccine Card Modal Specific Styles */
    #vaccineCardModal .modal-card {
      max-width: 95%;
      width: 1200px;
      background: linear-gradient(135deg, #2c5530 0%, #1a3d1f 100%);
      color: white;
      border-radius: 15px;
    }

    /* Modal info grid */
    .modal-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
      background: white;
      padding: 25px;
      border-radius: 10px;
      color: #333;
    }

    .modal-info-grid > div {
      display: flex;
      flex-direction: column;
    }

    .modal-info-grid label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .modal-info-grid input {
      padding: 10px;
      border: none;
      border-bottom: 2px solid #ddd;
      background: transparent;
      font-size: 14px;
      color: #333;
    }

    .modal-info-grid input:focus {
      outline: none;
      border-bottom-color: #2c5530;
    }

    /* Vaccine table in modal */
    .vaccine-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    .vaccine-table th {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      padding: 15px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    .vaccine-table td {
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: center;
      background: white;
      color: #333;
    }

    .vaccine-table tr:nth-child(even) td {
      background: #f9f9f9;
    }

    .vaccine-table input {
      border: none;
      background: transparent;
      width: 100%;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      color: #333;
    }

    .vaccine-table input:focus {
      outline: 2px solid #2c5530;
      border-radius: 3px;
    }

    .vaccine-table .vaccine-name {
      text-align: left;
      font-weight: 500;
    }



    .dose-badge {
      background: #e67e22;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }

    .modal-note {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #f39c12;
      font-size: 13px;
      color: white;
      border-radius: 5px;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .main-container {
        margin: 0 10px;
      }

      .preschooler-header {
        grid-template-columns: 1fr;
        gap: 20px;
        text-align: center;
      }

      .photo-section {
        justify-self: center;
      }

      .modal-info-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .info-table {
        min-width: 800px;
        margin-bottom: 0;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .back-button {
        top: 20px;
        right: 20px;
        padding: 10px 16px;
        font-size: 13px;
      }

      .preschooler-header {
        padding: 30px 25px;
        gap: 25px;
      }

      .content-section {
        padding: 30px 25px;
      }

      .photo-placeholder {
        width: 150px;
        height: 150px;
      }

      .child-name {
        font-size: 20px;
      }

      .info-section {
        padding: 20px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin: 30px 0 15px 0;
      }

      .section-header h4 {
        font-size: 18px;
      }

      .modal-card {
        width: 95%;
        padding: 15px;
      }

      .modal-info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 20px;
      }

      .vaccine-table {
        font-size: 12px;
        min-width: 700px;
      }

      .vaccine-table th,
      .vaccine-table td {
        padding: 8px 4px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        background: white;
      }

      .info-table {
        min-width: 900px;
        margin-bottom: 0;
        font-size: 12px;
      }

      .info-table th,
      .info-table td {
        padding: 12px 8px;
        white-space: nowrap;
        min-width: 80px;
      }

      .info-table th:first-child,
      .info-table td:first-child {
        min-width: 150px;
        position: sticky;
        left: 0;
        background: white;
        z-index: 1;
      }

      .info-table th:first-child {
        background: #f8f9fa;
      }

      .action-buttons {
        display: flex;
        flex-direction: row;
        gap: 5px;
        min-width: 120px;
      }

      .btn-sm {
        padding: 6px 10px;
        font-size: 10px;
        white-space: nowrap;
      }

      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        white-space: nowrap;
      }
    }

    @media (max-width: 480px) {
      .preschooler-header {
        padding: 20px;
        gap: 20px;
      }

      .content-section {
        padding: 20px;
      }

      .photo-placeholder {
        width: 120px;
        height: 120px;
      }

      .child-name {
        font-size: 18px;
      }

      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .info-value {
        text-align: left;
      }

      .modal-card {
        padding: 15px;
      }

      .section-header h4 {
        font-size: 16px;
      }

      .table-container {
        margin-left: -20px;
        margin-right: -20px;
        border-radius: 0;
        width: calc(100% + 40px);
      }

      .info-table {
        min-width: 800px;
        font-size: 11px;
      }

      .info-table th,
      .info-table td {
        padding: 8px 6px;
        min-width: 70px;
      }

      .info-table th:first-child,
      .info-table td:first-child {
        min-width: 120px;
      }
    }

    /* Add scroll indicator for better UX */
    .table-container::after {
      content: 'â†’ Scroll to see more';
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 11px;
      color: #666;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0.7;
      pointer-events: none;
    }

    @media (min-width: 769px) {
      .table-container::after {
        display: none;
      }
    }


    /* Mobile responsive for banner */
@media (max-width: 768px) {
  .archived-banner {
    padding: 15px 20px;
    font-size: 16px;
    margin: -15px -15px 15px -15px;
  }
  
  .archived-banner::before {
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .archived-banner {
    padding: 12px 15px;
    font-size: 14px;
    flex-direction: column;
    gap: 8px;
  }
}  


    .view-vaccine-btn {
      background-color: #5bdab3;
      color: #1e1e2f;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(91, 218, 179, 0.3);
      width: 100%;
      margin-top: 20px;
    }

    .view-vaccine-btn:hover {
      background-color: #1565c0;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(21, 101, 192, 0.4);
    }

    .close-container {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 10;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: #666;
      cursor: pointer;
      padding: 5px 10px;
      line-height: 1;
      transition: all 0.3s ease;
    }

  .close-btn:hover {
      color: #d32f2f;
    }

  </style>
</head>
<body>
  <div class="main-container">
    <!-- Back Button -->
    

    <!-- Profile Container -->
    <div class="profile-container p-4">
      <div class="close-container">
  <button class="close-btn" onclick="location.href='/parent-dashboard'" title="Close">&times;</button>
</div>

      <h2 class="mb-4">Preschooler Details</h2>


      
      <div class="row mb-4">
        <!-- Left Section -->
        <div class="col-lg-6 col-md-12 mb-4 mb-lg-0">
          <div class="d-flex flex-column align-items-center">
            <div class="photo-box">
              {% if preschooler.profile_photo %}
                <img src="{{ preschooler.profile_photo.url }}" alt="Preschooler Photo" class="preschooler-photo">
              {% else %}
                <img src="{% static 'media/default-profile.jpg' %}" alt="Default Photo" class="preschooler-photo">
              {% endif %}
            </div>

            <!-- Enhanced Upload Form for Native App -->
            <form id="uploadForm" class="upload-form" data-preschooler-id="{{ preschooler.preschooler_id }}" enctype="multipart/form-data">
              {% csrf_token %}
              
              <div class="file-input-wrapper">
                <!-- Hidden native file input -->
                <input 
                  type="file" 
                  id="fileInput"
                  name="profile_photo" 
                  accept="image/*"
                  capture="environment"
                  class="file-input-native"
                >
                
                <!-- Custom styled button -->
                <button type="button" id="fileButton" class="file-input-button">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z" fill="currentColor"/>
                  </svg>
                  Choose Photo
                </button>
                
                <!-- File name display -->
                <div id="fileNameDisplay" class="file-name-display"></div>
              </div>

              <!-- Upload button -->
              <button type="submit" id="uploadButton" class="upload-button" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" fill="currentColor"/>
                </svg>
                Upload Photo
              </button>
            </form>

            <div class="info text-center">
              <p><strong>{{ preschooler.first_name }} {{ preschooler.last_name }}</strong></p>
              <p><strong>Age:</strong> {{ age_years }} year(s), {{ age_months }} month(s), and {{ age_days }} day(s)</p>
              <p><strong>Gender:</strong> {{ preschooler.sex }}</p>
              <p><strong>Birth Date:</strong> {{ preschooler.birth_date|date:"m-d-Y" }}</p>
            </div>
          </div>
        </div>

        <!-- Right Section - Stats Grid -->
<div class="col-lg-6 col-md-12">
  <div class="row g-3">

    <!-- Weight-for-Age -->
    <div class="col-sm-6">
      <div class="stat-box">
        <p class="label">Weight for Age</p>
        <p class="value">
          {{ weight_for_age_status|default:"N/A" }}
        </p>
      </div>
    </div>

    <!-- Weight-for-Height -->
    <div class="col-sm-6">
      <div class="stat-box">
        <p class="label">Weight-for-Height</p>
        <p class="value">
          {{ weight_for_height_status|default:"N/A" }}
        </p>
      </div>
    </div>

    <!-- Height-for-Age -->
    <div class="col-sm-6">
      <div class="stat-box">
        <p class="label">Height for Age</p>
        <p class="value">
          {{ height_for_age_status|default:"N/A" }}
        </p>
      </div>
    </div>

    <!-- BMI -->
    <div class="col-sm-6">
  <div class="stat-box">
    <p class="label">BMI</p>
    <p class="value">
  {% if bmi_value %}
    {{ bmi_value|floatformat:2 }} ({{ nutritional_status }})
  {% else %}
    N/A
  {% endif %}
</p>
  </div>
</div>

  </div>
</div>

 </div>
        <button class="view-vaccine-btn" onclick="openVaccineCardModal()">View Vaccine Card</button>
      </div>


<!-- Vaccine Card Modal -->
<div id="vaccineCardModal" class="modal-overlay">
  <div class="modal-card">
    <button class="close-modal" onclick="closeVaccineCardModal()">Ã—</button>
    <h2 style="text-align: center; margin-bottom: 30px; font-size: 28px; font-weight: bold;">Child Immunization Record</h2>

    <div class="modal-info-grid">
      <div>
        <label>Child's name:</label>
        <input type="text" value="{{ preschooler.first_name }} {{ preschooler.last_name }}" readonly disabled>
      </div>
      <div>
        <label>Date of birth:</label>
        <input type="text" value="{{ preschooler.birth_date }}" readonly disabled>
      </div>
      <div>
        <label>Place of birth:</label>
        <input type="text" value="{{ preschooler.place_of_birth|default:'' }}" readonly disabled>
      </div>
      <div>
        <label>Mother's name:</label>
        <input type="text" value="{{ preschooler.parent_id.mother_name|default:'' }}" readonly disabled>
      </div>
      <div>
        <label>Father's name:</label>
        <input type="text" value="{{ preschooler.parent_id.father_name|default:'' }}" readonly disabled>
      </div>
      <div>
        <label>Address:</label>
        <input type="text" value="{{ preschooler.address|default:'' }}" readonly disabled>
      </div>
      <div>
        <label>Birth weight (kg):</label>
        <input type="text" value="{{ preschooler.birth_weight|default_if_none:'' }}" readonly disabled>
      </div>
      <div>
        <label>Birth height (cm):</label>
        <input type="text" value="{{ preschooler.birth_height|default_if_none:'' }}" readonly disabled>
      </div>
      <div>
        <label>Health Center:</label>
        <input type="text" value="{{ preschooler.health_center|default:'' }}" readonly disabled>
      </div>
      <div>
        <label>Barangay:</label>
        <input type="text" value="{{ preschooler.barangay.name }}" readonly disabled>
      </div>
      <div>
        <label>Sex:</label>
        <input type="text" value="{{ preschooler.sex }}" readonly disabled>
      </div>
    </div>

      

      <!-- RESPONSIVE VACCINE TABLE with Bootstrap -->
    <div class="table-responsive">
      <table class="vaccine-table table table-bordered table-hover">
        <thead>
          <tr>
            <th style="min-width: 150px;">Vaccine</th>
            <th style="min-width: 80px;">Doses</th>
            <th style="min-width: 120px;">Date of Vaccination<br><small style="font-weight: normal;">MM/DD/YY</small></th>
            <th style="min-width: 100px;">Status</th>
            <th style="min-width: 150px;">Remarks</th>
          </tr>
        </thead>
        <tbody>
          {% for h in immunization_history %}
          {% if h.status == 'completed' %}
          <tr>
            <td class="vaccine-name">{{ h.vaccine_name }}</td>
            <td><span class="dose-badge">{{ h.dose_number|default:1 }}</span> / {{ h.required_doses }}</td>
            <td>{{ h.completion_date|date:"m/d/Y"|default:"N/A" }}</td>
            <td>Completed</td>
            <td>{{ h.medical_remarks|default:"" }}</td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="5" class="text-center fst-italic text-muted">
              No completed vaccinations recorded yet
            </td>
          </tr>
          {% endfor %}
          
          {% if pending_schedules %}
          <tr>
            <td colspan="5" style="background: #f0f8ff; padding: 10px;" class="text-center fst-italic text-primary">
              Additional scheduled vaccinations: {{ pending_schedules|length }} appointment(s) pending
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <p class="modal-note">
      This is a read-only view of the child's immunization record. All completed vaccinations are displayed above.
    </p>
  </div>
</div>


      <!-- Immunization Table -->
      <div class="row">
        <div class="col-12">
          <h3 class="section-title">Immunization History</h3>
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Vaccine Name</th>
                  <th>Doses</th>
                  <th>Date Given</th>
                </tr>
              </thead>
              <tbody>
                {% for record in immunization_history %}
                <tr>
                  <td>{{ record.vaccine_name }}</td>
                  <td>{{ record.doses }}</td>
                  <td>{{ record.given_date|date:"m/d/Y" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center">No immunization record found.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Nutrition Services Table -->
      <div class="row mt-4">
        <div class="col-12">
          <h3 class="section-title">Nutrition History</h3>
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Service Type</th>
                  <th>Date Completed</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for service in nutrition_services %}
                <tr>
                  <td>{{ service.service_type }}</td>
                  <td>{{ service.completion_date|date:"m-d-Y" }}</td>
                  <td>
                    <span class="status-completed">
                      Completed
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center">No nutrition services recorded.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const uploadForm = document.getElementById("uploadForm");
      const fileInput = document.getElementById("fileInput");
      const fileButton = document.getElementById("fileButton");
      const uploadButton = document.getElementById("uploadButton");
      const fileNameDisplay = document.getElementById("fileNameDisplay");
      const preschoolerId = uploadForm.dataset.preschoolerId;

      // Detect if running in WebView (Android app)
      const isWebView = /wv|WebView/i.test(navigator.userAgent) || 
                       window.Android !== undefined ||
                       window.webkit !== undefined;

      console.log('Running in WebView:', isWebView);

      // Enhanced file button click handler
      fileButton.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('File button clicked');
        
        // Multiple methods to trigger file chooser for better compatibility
        try {
          // Method 1: Direct click (standard)
          fileInput.click();
          console.log('Method 1: Direct click triggered');
        } catch (error1) {
          console.log('Method 1 failed:', error1);
          
          try {
            // Method 2: Programmatic event dispatch
            const clickEvent = new MouseEvent('click', {
              bubbles: true,
              cancelable: true,
              view: window
            });
            fileInput.dispatchEvent(clickEvent);
            console.log('Method 2: Event dispatch triggered');
          } catch (error2) {
            console.log('Method 2 failed:', error2);
            
            try {
              // Method 3: Focus and trigger (WebView fallback)
              fileInput.focus();
              fileInput.click();
              console.log('Method 3: Focus + click triggered');
            } catch (error3) {
              console.log('Method 3 failed:', error3);
              
              // Method 4: Show manual instruction for extreme cases
              if (isWebView) {
                Swal.fire({
                  title: 'Select Photo',
                  html: 'Please use the file input below to select a photo:<br><br>' +
                        '<input type="file" id="manualFileInput" accept="image/*" capture="environment" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">',
                  showConfirmButton: false,
                  showCloseButton: true,
                  didOpen: () => {
                    const manualInput = document.getElementById('manualFileInput');
                    manualInput.addEventListener('change', function() {
                      if (this.files && this.files[0]) {
                        // Transfer file to main input
                        try {
                          const dt = new DataTransfer();
                          dt.items.add(this.files[0]);
                          fileInput.files = dt.files;
                          
                          // Trigger change event
                          const changeEvent = new Event('change', { bubbles: true });
                          fileInput.dispatchEvent(changeEvent);
                          
                          Swal.close();
                        } catch (transferError) {
                          console.log('File transfer failed:', transferError);
                          // Fallback: process file directly
                          handleFileSelection(this.files[0]);
                          Swal.close();
                        }
                      }
                    });
                  }
                });
              }
            }
          }
        }
      });

      // Enhanced file selection handler
      fileInput.addEventListener("change", function(e) {
        console.log('File input changed:', this.files);
        
        if (this.files && this.files[0]) {
          handleFileSelection(this.files[0]);
        } else {
          resetFileSelection();
        }
      });

      function handleFileSelection(file) {
        console.log('File selected:', file.name, file.size, file.type);
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          Swal.fire('Invalid File', 'Please select an image file.', 'error');
          resetFileSelection();
          return;
        }

        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          Swal.fire('File Too Large', 'Please select an image smaller than 10MB.', 'error');
          resetFileSelection();
          return;
        }

        const fileName = file.name;
        const displayName = fileName.length > 30 ? fileName.substring(0, 27) + '...' : fileName;
        
        fileButton.textContent = 'Photo Selected';
        fileButton.classList.add('file-selected');
        fileNameDisplay.textContent = displayName;
        uploadButton.disabled = false;
        uploadButton.style.opacity = '1';
      }

      function resetFileSelection() {
        fileButton.textContent = 'Choose Photo';
        fileButton.classList.remove('file-selected');
        fileNameDisplay.textContent = '';
        uploadButton.disabled = true;
        uploadButton.style.opacity = '0.5';
      }

      // Form submission handler
      uploadForm.addEventListener("submit", function (e) {
        e.preventDefault();
        
        if (!fileInput.files || !fileInput.files[0]) {
          Swal.fire("No file selected", "Please select a photo first.", "warning");
          return;
        }

        const formData = new FormData(uploadForm);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Show loading state
        const originalHTML = uploadButton.innerHTML;
        uploadButton.innerHTML = `
          <div style="display: inline-block; animation: spin 1s linear infinite;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
            </svg>
          </div>
          Uploading...`;
        uploadButton.disabled = true;

        fetch(`/preschooler/${preschoolerId}/upload-photo/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken },
          body: formData,
        })
        .then(response => {
          if (!response.ok) throw new Error("Upload failed");
          return response.json();
        })
        .then(data => {
          Swal.fire({
            icon: "success",
            title: "Photo updated successfully!",
            showConfirmButton: false,
            timer: 1500
          });

          // Update the image with cache busting
          const img = document.querySelector(".preschooler-photo");
          img.src = data.new_photo_url + '?t=' + new Date().getTime();
          
          // Reset form state
          resetFileSelection();
          fileInput.value = '';
        })
        .catch(err => {
          console.error('Upload error:', err);
          Swal.fire("Upload failed", "Something went wrong. Please try again.", "error");
        })
        .finally(() => {
          // Reset upload button
          uploadButton.innerHTML = originalHTML;
          uploadButton.disabled = fileInput.files.length === 0;
        });
      });

      // Additional event listeners for native app compatibility
      if (isWebView) {
        console.log('Setting up WebView specific handlers');
        
        // Listen for native app file selection events
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'fileSelected') {
            console.log('Received file selection from native app:', event.data);
            // Handle file data from native app if needed
          }
        });

        // Expose function for native app to call
        window.handleNativeFileSelection = function(fileData) {
          console.log('Native file selection handler called:', fileData);
          // Process file data from native app if needed
        };
      }

      // Handle other UI interactions
      const notifBtn = document.getElementById("notifBtn");
      const profileBtn = document.getElementById("profileBtn");
      const profileMenu = document.getElementById("profileMenu");
      const logoutBtn = document.querySelector(".logout-btn");

      if (logoutBtn) {
        logoutBtn.addEventListener("click", function(e) {
          e.preventDefault();
          const logoutUrl = this.getAttribute("data-url");

          Swal.fire({
            title: 'Are you sure?',
            text: "You will be logged out of your account.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, log me out',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = logoutUrl;
            }
          });
        });
      }

      if (notifBtn) {
        notifBtn.addEventListener("click", () => {
          Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'info',
            title: 'No new notifications.',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
          });
        });
      }

      if (profileBtn && profileMenu) {
        profileBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          profileMenu.style.display = profileMenu.style.display === "flex" ? "none" : "flex";
        });

        document.addEventListener("click", (e) => {
          if (!e.target.closest(".profile-dropdown")) {
            profileMenu.style.display = "none";
          }
        });
      }

      // Debug logging for WebView
      if (isWebView) {
        console.log('WebView environment detected');
        console.log('User agent:', navigator.userAgent);
        console.log('File input support:', 'File' in window);
        console.log('FileList support:', 'FileList' in window);
      }
    });
  </script>


<script>
  function openVaccineCardModal() {
      document.getElementById('vaccineCardModal').style.display = 'flex';
    }

    function closeVaccineCardModal() {
      document.getElementById('vaccineCardModal').style.display = 'none';
    }
</script>
</body>
</html>




