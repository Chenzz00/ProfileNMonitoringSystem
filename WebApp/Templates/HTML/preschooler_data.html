<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Preschooler Details</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'media/PPMS-logo.png' %}">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
      font-size: 14px;
      font-weight: 400;
      background: url('{% static "media/loginbg.png" %}') center/cover no-repeat fixed;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .close-container {
  position: absolute;
  top: 15px;
  right: 15px;
  z-index: 10;
}

.close-btn {
  background: none;
  border: none;
  font-size: 28px;
  color: #666;
  cursor: pointer;
  padding: 5px 10px;
  line-height: 1;
  transition: all 0.3s ease;
}

.close-btn:hover {
  color: #d32f2f;
}



    .preschooler-details {
        position: relative;  /* ADD this line */
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
    }

    .preschooler-header {
      display: grid;
      grid-template-columns: 200px 1fr 1fr;
      gap: 30px;
      padding: 40px;
      background: white;
      color: #333;
      border-bottom: 1px solid #e0e0e0;
    }

    .photo-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .photo-placeholder {
      width: 180px;
      height: 180px;
      background-color: #f0f0f0;
      border: 2px dashed #ccc;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-placeholder img.child-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    .default-photo-box {
      color: #666;
      font-size: 14px;
      text-align: center;
    }

    .child-name {
      font-size: 24px;
      font-weight: 700;
      margin-top: 15px;
      text-align: center;
      color: #333;
    }

    .info-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .info-section h3 {
      color: #333;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid #5bdab3;
      padding-bottom: 8px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 0;
    }

    .info-label {
      font-weight: 500;
      color: #666;
      font-size: 14px;
    }

    .info-value {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      text-align: right;
    }

    .view-vaccine-btn {
      background-color: #5bdab3;
      color: #1e1e2f;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(91, 218, 179, 0.3);
      width: 100%;
      margin-top: 20px;
    }

    .view-vaccine-btn:hover {
      background-color: #1565c0;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(21, 101, 192, 0.4);
    }

    .content-section {
      padding: 40px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 20px 0;
      padding-bottom: 15px;
      border-bottom: 2px solid #5bdab3;
    }

    .section-header h4 {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .add-schedule-btn, .add-nutrition-btn {
      background-color: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
    }

    .add-schedule-btn:hover, .add-nutrition-btn:hover {
      background-color: #218838;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      background: white;
      position: relative;
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: none;
      margin-bottom: 0;
    }

    .info-table th {
      background-color: #f8f9fa;
      color: #333;
      padding: 15px 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e9ecef;
    }

    .info-table td {
      border-bottom: 1px solid #e9ecef;
      padding: 15px 12px;
      text-align: center;
      font-size: 14px;
      color: #333;
      background: white;
    }

    .info-table tr:hover td {
      background: #f8f9fa;
    }

    .info-table tr:last-child td {
      border-bottom: none;
    }

    .info-table th:last-child,
    .info-table td:last-child {
      text-align: center;
    }

    /* Status badge styles */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      display: inline-block;
    }

    .status-scheduled { 
      background: #e3f2fd; 
      color: #1565c0;
    }

    .status-completed { 
      background: #e8f5e8; 
      color: #2e7d32;
    }

    .status-rescheduled { 
      background: #fff3e0; 
      color: #f57c00;
    }

    .status-missed { 
      background: #ffebee; 
      color: #d32f2f;
    }

    .status-pending { 
      background: #fffde7; 
      color: #f9a825;
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn-complete { background: #4caf50; color: white; }
    .btn-reschedule { background: #ff9800; color: white; }
    .btn-schedule { background: #4caf50; color: white; }
    .btn-complete:hover { background: #45a049; }
    .btn-reschedule:hover { background: #e68900; }
    .btn-schedule:hover { background: #45a049; }
    .text-success { color: #2e7d32; font-weight: 500; }

    /* Age-based button styles */
    .btn-disabled-future {
      background-color: #f5f5f5 !important;
      color: #999 !important;
      border: 1px dashed #ccc !important;
      font-size: 10px !important;
      padding: 4px 3px !important;
      cursor: not-allowed !important;
    }

    .btn-disabled-future:hover {
      background-color: #f5f5f5 !important;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn-available-today {
      background-color: #4caf50 !important;
      animation: glow 2s infinite;
    }

    @keyframes glow {
      0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
      50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
      100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .schedule-modal-card {
      max-width: 500px;
      width: 90%;
    }

    .schedule-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #ffffff;
      z-index: 1001;
    }

    .close-modal:hover {
      color: #000;
    }

    .schedule-close-modal {
      color: #333;
    }

    .schedule-close-modal:hover {
      color: #666;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Button styles */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.3s;
    }

    .btn-green {
      background-color: #4caf50;
      color: white;
    }

    .btn-green:hover {
      background-color: #45a049;
    }

    .btn-gray {
      background-color: #6c757d;
      color: white;
    }

    .btn-gray:hover {
      background-color: #545b62;
    }

    .btn-blue {
      background-color: #007bff;
      color: white;
    }

    .btn-blue:hover {
      background-color: #0056b3;
    }

    .btn-orange {
      background-color: #ff9800;
      color: white;
    }

    .btn-orange:hover {
      background-color: #e68900;
    }

    .modal-action-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Vaccine Card Modal Specific Styles */
    #vaccineCardModal .modal-card {
      max-width: 95%;
      width: 1200px;
      background: linear-gradient(135deg, #2c5530 0%, #1a3d1f 100%);
      color: white;
      border-radius: 15px;
    }

    /* Modal info grid */
    .modal-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
      background: white;
      padding: 25px;
      border-radius: 10px;
      color: #333;
    }

    .modal-info-grid > div {
      display: flex;
      flex-direction: column;
    }

    .modal-info-grid label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .modal-info-grid input {
      padding: 10px;
      border: none;
      border-bottom: 2px solid #ddd;
      background: transparent;
      font-size: 14px;
      color: #333;
    }

    .modal-info-grid input:focus {
      outline: none;
      border-bottom-color: #2c5530;
    }

    /* Vaccine table in modal */
    .vaccine-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    .vaccine-table th {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      padding: 15px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
    }

    .vaccine-table td {
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: center;
      background: white;
      color: #333;
    }

    .vaccine-table tr:nth-child(even) td {
      background: #f9f9f9;
    }

    .vaccine-table input {
      border: none;
      background: transparent;
      width: 100%;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      color: #333;
    }

    .vaccine-table input:focus {
      outline: 2px solid #2c5530;
      border-radius: 3px;
    }

    .vaccine-table .vaccine-name {
      text-align: left;
      font-weight: 500;
    }

    .dose-badge {
      background: #e67e22;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
    }

    .modal-note {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #f39c12;
      font-size: 13px;
      color: white;
      border-radius: 5px;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .main-container {
        margin: 0 10px;
      }

      .preschooler-header {
        grid-template-columns: 1fr;
        gap: 20px;
        text-align: center;
      }

      .photo-section {
        justify-self: center;
      }

      .modal-info-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .info-table {
        min-width: 800px;
        margin-bottom: 0;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .back-button {
        top: 20px;
        right: 20px;
        padding: 10px 16px;
        font-size: 13px;
      }

      .preschooler-header {
        padding: 30px 25px;
        gap: 25px;
      }

      .content-section {
        padding: 30px 25px;
      }

      .photo-placeholder {
        width: 150px;
        height: 150px;
      }

      .child-name {
        font-size: 20px;
      }

      .info-section {
        padding: 20px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin: 30px 0 15px 0;
      }

      .section-header h4 {
        font-size: 18px;
      }

      .modal-card {
        width: 95%;
        padding: 15px;
      }

      .modal-info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
        padding: 20px;
      }

      .vaccine-table {
        font-size: 12px;
        min-width: 700px;
      }

      .vaccine-table th,
      .vaccine-table td {
        padding: 8px 4px;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        background: white;
      }

      .info-table {
        min-width: 900px;
        margin-bottom: 0;
        font-size: 12px;
      }

      .info-table th,
      .info-table td {
        padding: 12px 8px;
        white-space: nowrap;
        min-width: 80px;
      }

      .info-table th:first-child,
      .info-table td:first-child {
        min-width: 150px;
        position: sticky;
        left: 0;
        background: white;
        z-index: 1;
      }

      .info-table th:first-child {
        background: #f8f9fa;
      }

      .action-buttons {
        display: flex;
        flex-direction: row;
        gap: 5px;
        min-width: 120px;
      }

      .btn-sm {
        padding: 6px 10px;
        font-size: 10px;
        white-space: nowrap;
      }

      .status-badge {
        font-size: 10px;
        padding: 3px 6px;
        white-space: nowrap;
      }
    }

    @media (max-width: 480px) {
      .preschooler-header {
        padding: 20px;
        gap: 20px;
      }

      .content-section {
        padding: 20px;
      }

      .photo-placeholder {
        width: 120px;
        height: 120px;
      }

      .child-name {
        font-size: 18px;
      }

      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .info-value {
        text-align: left;
      }

      .modal-card {
        padding: 15px;
      }

      .section-header h4 {
        font-size: 16px;
      }

      .table-container {
        margin-left: -20px;
        margin-right: -20px;
        border-radius: 0;
        width: calc(100% + 40px);
      }

      .info-table {
        min-width: 800px;
        font-size: 11px;
      }

      .info-table th,
      .info-table td {
        padding: 8px 6px;
        min-width: 70px;
      }

      .info-table th:first-child,
      .info-table td:first-child {
        min-width: 120px;
      }
    }

    /* Add scroll indicator for better UX */
    .table-container::after {
      content: 'â†’ Scroll to see more';
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 11px;
      color: #666;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0.7;
      pointer-events: none;
    }

    @media (min-width: 769px) {
      .table-container::after {
        display: none;
      }
    }

        /* Archived Banner Styles */
.archived-banner {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px 30px;
  text-align: center;
  font-weight: 600;
  font-size: 18px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  margin: -20px -20px 20px -20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  border-bottom: 4px solid #5a67d8;
}

.archived-banner::before {
  content: "";
  font-size: 28px;
}



    /* Disabled state for archived records */
.archived-disabled {
  pointer-events: none !important;
  opacity: 0.6 !important;
  cursor: not-allowed !important;
  position: relative;
}

.archived-disabled::after {
  content: "";
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 20px;
  opacity: 0.7;
}

/* Disable buttons when archived */
button.archived-disabled,
.btn.archived-disabled {
  background-color: #e0e0e0 !important;
  color: #999 !important;
  cursor: not-allowed !important;
  pointer-events: none !important;
  opacity: 0.5 !important;
  box-shadow: none !important;
}

/* Read-only inputs */
input[readonly].archived-input,
select[disabled].archived-input,
textarea[readonly].archived-input {
  background-color: #f5f5f5 !important;
  color: #666 !important;
  cursor: not-allowed !important;
  border-color: #ddd !important;
}

/* Mobile responsive for banner */
@media (max-width: 768px) {
  .archived-banner {
    padding: 15px 20px;
    font-size: 16px;
    margin: -15px -15px 15px -15px;
  }
  
  .archived-banner::before {
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .archived-banner {
    padding: 12px 15px;
    font-size: 14px;
    flex-direction: column;
    gap: 8px;
  }
}  
  </style>
</head>

<body>
<div class="main-container">

   {% if is_archived %}
<div class="archived-banner">
  This preschooler has been archived and cannot be edited
</div>
{% endif %}


  <div class="preschooler-details">
  <div class="close-container">
    <button class="close-btn" onclick="goBack()" title="Close">&times;</button>
  </div>
    <!-- Header Section with Photo and Basic Info -->
    <div class="preschooler-header">
      <!-- Photo Section -->
      <div class="photo-section">
        <div class="photo-placeholder">
          {% if preschooler.profile_photo %}
            <img src="{{ preschooler.profile_photo.url }}" alt="Photo of {{ preschooler.first_name }}" class="child-photo">
          {% else %}
            <div class="default-photo-box">No Photo</div>
          {% endif %}
        </div>
        <div class="child-name">{{ preschooler.first_name }} {{ preschooler.last_name }}</div>
      </div>

      <!-- Basic Information -->
      <div class="info-section">
        <h3>Basic Information</h3>
        <div class="info-item">
          <span class="info-label">Age:</span>
          <span class="info-value">{{ age_years }} years, {{ age_months }} months, {{ age_days }} days</span>
        </div>
        <div class="info-item">
          <span class="info-label">Barangay:</span>
          <span class="info-value">{{ preschooler.barangay.name }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Gender:</span>
          <span class="info-value">{{ preschooler.sex }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Birth Date:</span>
          <span class="info-value">{{ preschooler.birth_date }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Time of birth:</span>
          <span class="info-value">{{ preschooler.time_of_birth|default:'' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Place of birth:</span>
          <span class="info-value">{{ preschooler.place_of_birth|default:'' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Type of Birth:</span>
          <span class="info-value">{{ preschooler.type_of_birth|default:'' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Place of Delivery:</span>
          <span class="info-value">{{ preschooler.place_of_delivery|default:'' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Parent:</span>
          <span class="info-value">{{ preschooler.parent_id.full_name|default:'' }}</span>
        </div>
      </div>

      <!-- Health Information -->
      <div class="info-section">
        <h3>Health Information</h3>
        <div class="info-item">
          <span class="info-label">Weight:</span>
          <span class="info-value">{% if bmi %}{{ bmi.weight }} kg{% else %}N/A{% endif %}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Height:</span>
          <span class="info-value">{% if bmi %}{{ bmi.height }} cm{% else %}N/A{% endif %}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Birth height:</span>
          <span class="info-value">{{ preschooler.birth_height|default_if_none:'' }} cm</span>
        </div>
        <div class="info-item">
          <span class="info-label">Birth weight:</span>
          <span class="info-value">{{ preschooler.birth_weight|default_if_none:'' }} kg</span>
        </div>
        <div class="info-item">
          <span class="info-label">Weight-for-Age Status:</span>
          <span class="info-value">{{ weight_for_age_status }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Height-for-Age Status:</span>
          <span class="info-value">{{ height_for_age_status }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Weight-for-Height Status:</span>
          <span class="info-value">{{ weight_for_height_status|default:"-" }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">BMI:</span>
          <span class="info-value">
            {% if bmi %}{{ bmi.bmi_value|floatformat:2 }}{% else %}N/A{% endif %}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">Nutritional status:</span>
          <span class="info-value">{{ nutritional_status }}</span>
        </div>
        <button class="view-vaccine-btn" onclick="openVaccineCardModal()">View Vaccine Card</button>
      </div>
    </div>

    <!-- Content Section -->
    <div class="content-section">
      <!-- Enhanced Immunization Schedule with Age-Based Scheduling -->
      <div class="section-header">
        <h4>Immunization Schedule</h4>
      </div>
      
      <div class="table-container">
        <table class="info-table">
          <tr>
            <th>Vaccine Name</th>
            <th>Given / Required Doses</th>
            <th>Immunization Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>

          <!-- Enhanced vaccine rows with age-based logic -->
          {% for vaccine in vaccine_statuses %}
          <tr>
            <td>{{ vaccine.name }}</td>
            <td>{{ vaccine.completed_doses }}/{{ vaccine.total_doses }}</td>
            <td>{{ vaccine.immunization_date|default:"N/A" }}</td>
            <td>
              {% if vaccine.status == 'completed' %}
                <span class="status-badge status-completed">COMPLETE</span>
              {% elif vaccine.status == 'scheduled' %}
                <span class="status-badge status-scheduled">SCHEDULED</span>
              {% elif vaccine.status == 'rescheduled' %}
                <span class="status-badge status-rescheduled">RESCHEDULED</span>
              {% elif vaccine.status == 'missed' %}
                <span class="status-badge status-missed">MISSED</span>
              {% else %}
                <span class="status-badge status-pending">PENDING</span>
              {% endif %}
            </td>
            <td>
              {% if vaccine.status == 'completed' and vaccine.completed_doses == vaccine.total_doses %}
                <span class="text-success"> Complete</span>
                
              {% elif vaccine.status == 'scheduled' or vaccine.status == 'rescheduled' %}
                <div class="action-buttons">
                  <button 
                    class="btn-sm btn-complete"
                    onclick="completeCurrentDose('{{ vaccine.name }}', {{ vaccine.schedule_id }}, '{{ vaccine.completed_doses }}', '{{ vaccine.total_doses }}')"
                    data-scheduled-date="{{ vaccine.scheduled_date|default:'' }}"
                    data-vaccine-name="{{ vaccine.name }}">
                    Complete
                  </button>
                  <button class="btn-sm btn-reschedule" onclick="openRescheduleModal({{ vaccine.schedule_id }})">
                    Reschedule
                  </button>
                </div>
                
              {% elif vaccine.can_schedule %}
                <!-- Child is old enough for next dose -->
                <button 
                  class="btn-sm btn-schedule btn-available-today" 
                  onclick="scheduleVaccineWithAge('{{ vaccine.name }}', '{{ vaccine.total_doses }}', '{{ vaccine.eligible_dose.dose }}', '{{ vaccine.eligible_dose.description }}')"
                  title="{{ vaccine.next_dose_info }}">
                  Schedule Dose {{ vaccine.eligible_dose.dose }}
                </button>
                
              {% elif vaccine.future_dose %}
                <!-- Child is not old enough yet -->
                <button 
                  class="btn-sm btn-disabled-future" 
                  disabled
                  title="{{ vaccine.future_dose.reason }}">
                  Available in {{ vaccine.future_dose.age_months|floatformat:1 }} months
                </button>
                
              {% else %}
                <span class="text-success">Complete</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Immunization History -->
      <div class="section-header">
        <h4>Immunization History</h4>
        <button class="add-schedule-btn" onclick="openAddVaccineModal()">+ Add Completed Vaccine</button>
      </div>
      
      <div class="table-container">
        <table class="info-table">
          <tr>
            <th>Vaccine Name</th>
            <th>Dose</th>
            <th>Immunization Date</th>
            <th>Status</th>
          </tr>
          {% for h in immunization_history %}
          <tr>
            <td>{{ h.vaccine_name }}</td>
            <td>{{ h.doses|default:1 }}</td>
            <td>{{ h.scheduled_date|date:"m/d/Y" }}</td>
            <td>
              <span class="status-badge status-{{ h.status }}">
                {{ h.get_status_display }}
              </span>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4">No immunization history found.</td></tr>
          {% endfor %}
        </table>
      </div>

      <!-- Nutrition Services -->
      <div class="section-header">
        <h4>Nutrition Services Schedule</h4>
      </div>

      <div class="table-container">
        <table class="info-table">
          <tr>
            <th>Service Type</th>
            <th>Given / Required Doses</th>
            <th>Nutrition Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>

          {% for nutrition in nutrition_statuses %}
          <tr>
            <td>{{ nutrition.name }}</td>
            <td>{{ nutrition.completed_doses }}/{{ nutrition.total_doses }}</td>
            <td>{{ nutrition.service_date|default:"N/A" }}</td>
            <td>
              {% if nutrition.status == 'completed' %}
                <span class="status-badge status-completed">COMPLETE</span>
              {% elif nutrition.status == 'scheduled' %}
                <span class="status-badge status-scheduled">SCHEDULED</span>
              {% elif nutrition.status == 'rescheduled' %}
                <span class="status-badge status-rescheduled">RESCHEDULED</span>
              {% elif nutrition.status == 'missed' %}
                <span class="status-badge status-missed">MISSED</span>
              {% else %}
                <span class="status-badge status-pending">PENDING</span>
              {% endif %}
            </td>
            <td>
              {% if nutrition.status == 'completed' and nutrition.completed_doses == nutrition.total_doses %}
                <span class="text-success"> Complete</span>
                
              {% elif nutrition.status == 'scheduled' or nutrition.status == 'rescheduled' %}
                <div class="action-buttons">
                  <button class="btn-sm btn-complete" onclick="updateNutritionStatus({{ nutrition.schedule_id }}, 'completed')">
                    Complete
                  </button>
                  <button class="btn-sm btn-reschedule" onclick="openRescheduleNutritionModal({{ nutrition.schedule_id }})">
                    Reschedule
                  </button>
                </div>
                
              {% elif nutrition.can_schedule %}
                <!-- Child is eligible for nutrition service -->
                <button 
                  class="btn-sm btn-schedule btn-available-today" 
                  onclick="scheduleNutritionServiceWithAge('{{ nutrition.name }}', '{{ nutrition.eligibility_reason }}')"
                  title="{{ nutrition.age_description }}">
                  Schedule
                </button>
                
              {% elif nutrition.next_eligible_age %}
                <!-- Child is not eligible yet -->
                <button 
                  class="btn-sm btn-disabled-future" 
                  disabled
                  title="{{ nutrition.eligibility_reason }}">
                  Available at {{ nutrition.next_eligible_age }} months
                </button>
                
              {% else %}
                <!-- Default case or service completed -->
                {% if nutrition.eligibility_reason %}
                  <span class="text-muted" title="{{ nutrition.eligibility_reason }}">{{ nutrition.age_description }}</span>
                {% else %}
                  <button class="btn-sm btn-schedule" onclick="scheduleNutritionService('{{ nutrition.name }}')">
                    Schedule
                  </button>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <!-- Default rows when no nutrition data exists -->
          <tr>
            <td>Vitamin A</td>
            <td>0/10</td>
            <td>N/A</td>
            <td><span class="status-badge status-pending">PENDING</span></td>
            <td>
              <button 
                class="btn-sm btn-disabled-future" 
                disabled
                title="Age-based scheduling - available every 6 months starting at 6 months">
                Age-based scheduling
              </button>
            </td>
          </tr>
          <tr>
            <td>Deworming</td>
            <td>0/10</td>
            <td>N/A</td>
            <td><span class="status-badge status-pending">PENDING</span></td>
            <td>
              <button 
                class="btn-sm btn-disabled-future" 
                disabled
                title="Age-based scheduling - available every 6 months starting at 6 months">
                Age-based scheduling
              </button>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Nutritional Status History -->
      <div class="section-header">
        <h4>Nutritional Status History</h4>
      </div>
      
      <div class="table-container">
        <table class="info-table">
          <tr>
            <th>Date Measured</th>
            <th>Temperature (Â°C)</th>
            <th>Height (cm)</th>
            <th>Weight (kg)</th>
            <th>BMI</th>
            <th>Nutritional Status</th>
            <th>Weight for Age</th>
            <th>Height for Age</th>
            <th>Weight for Height</th>
          </tr>
          {% for record in bmi_with_temps %}
          <tr>
            <td>{{ record.date_recorded|date:"M d, Y" }}</td>
            <td>{% if record.temperature %}{{ record.temperature|floatformat:1 }}{% else %}N/A{% endif %}</td>
            <td>{{ record.height|floatformat:2 }}</td>
            <td>{{ record.weight|floatformat:2 }}</td>
            <td>{{ record.bmi_value|floatformat:2 }}</td>
            <td>{{ nutritional_status }}</td>
            <td>{{ record.weight_for_age_status }}</td>
            <td>{{ record.height_for_age_status }}</td>
            <td>{{ record.weight_for_height_status }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9">No records found.</td></tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Vaccine Card Modal -->
<div id="vaccineCardModal" class="modal-overlay">
  <div class="modal-card">
    <button class="close-modal" onclick="closeVaccineCardModal()">x</button>
    <h2 style="text-align: center; margin-bottom: 30px; font-size: 28px; font-weight: bold;">Child Immunization Record</h2>

    <form method="POST" action="{% url 'update_child_info' preschooler.preschooler_id %}">
      {% csrf_token %}
      <div class="modal-info-grid">
        <div>
          <label>Child's name:</label>
          <input type="text" value="{{ preschooler.first_name }} {{ preschooler.last_name }}" readonly>
        </div>
        <div>
          <label>Date of birth:</label>
          <input type="text" value="{{ preschooler.birth_date }}" readonly>
        </div>
        <div>
          <label>Place of birth:</label>
          <input type="text" name="place_of_birth" value="{{ preschooler.place_of_birth|default:'' }}">
        </div>
        <div>
          <label>Mother's name:</label>
          <input type="text" name="mother_name" value="{{ preschooler.parent_id.mother_name|default:'' }}">
        </div>
        <div>
          <label>Father's name:</label>
          <input type="text" name="father_name" value="{{ preschooler.parent_id.father_name|default:'' }}">
        </div>
        <div>
          <label>Address:</label>
          <input type="text" name="address" value="{{ preschooler.address|default:'' }}">
        </div>
        <div>
          <label>Birth weight (kg):</label>
          <input type="number" name="birth_weight" step="0.01" value="{{ preschooler.birth_weight|default_if_none:'' }}">
        </div>
        <div>
          <label>Birth height (cm):</label>
          <input type="number" name="birth_height" step="0.01" value="{{ preschooler.birth_height|default_if_none:'' }}">
        </div>
        <div>
          <label>Health Center:</label>
          <input type="text" name="health_center" value="{{ preschooler.health_center|default:'' }}">
        </div>
        <div>
          <label>Barangay:</label>
          <input type="text" value="{{ preschooler.barangay.name }}" readonly>
        </div>
        <div>
          <label>Sex:</label>
          <div style="display: flex; gap: 20px; margin-top: 8px;">
            <label style="display: flex; align-items: center; font-weight: normal;">
              <input type="radio" name="sex" value="Male" {% if preschooler.sex == 'Male' %}checked{% endif %} disabled style="margin-right: 8px;"> Male
            </label>
            <label style="display: flex; align-items: center; font-weight: normal;">
              <input type="radio" name="sex" value="Female" {% if preschooler.sex == 'Female' %}checked{% endif %} disabled style="margin-right: 8px;"> Female
            </label>
          </div>
        </div>
      </div>

      <div class="modal-action-buttons">
        <button type="button" class="btn btn-orange" onclick="generatePDF()">ðŸ“„ Save as PDF</button>
        <button type="submit" class="btn btn-green">Save Changes</button>
      </div>

      <!-- FIXED VACCINE TABLE - Only shows completed vaccinations -->
      <table class="vaccine-table">
        <thead>
          <tr>
            <th style="width: 25%;">Vaccine</th>
            <th style="width: 15%;">Doses</th>
            <th style="width: 15%;">Date of Vaccination<br><small style="font-weight: normal;">MM/DD/YY</small></th>
            <th style="width: 20%;">Status</th>
            <th style="width: 35%;">Remarks</th>
          </tr>
        </thead>
        <tbody>
          <!-- Only show COMPLETED immunizations, not scheduled ones -->
          {% for h in immunization_history %}
          {% if h.status == 'completed' %}
          <tr>
            <td class="vaccine-name">{{ h.vaccine_name }}</td>
            <td><span class="dose-badge">{{ h.dose_number|default:1 }}</span> / {{ h.required_doses }}</td>
            <td>
              <input type="date" 
                     name="vaccine_date_{{ h.id }}" 
                     value="{{ h.completion_date|date:'Y-m-d' }}" 
                     readonly 
                     style="pointer-events: none; background: transparent; border: none;">
            </td>
            <td>
              <input type="text" 
                     name="vaccine_status_{{ h.id }}" 
                     value="Completed" 
                     readonly 
                     style="pointer-events: none; background: transparent; border: none;">
            </td>
            <td>
              <!-- Only show medical remarks, NOT reschedule reasons -->
              <input type="text" 
                     name="vaccine_remarks_{{ h.id }}" 
                     value="{{ h.medical_remarks|default:'' }}" 
                     readonly 
                     style="pointer-events: none; background: transparent; border: none;">
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="5" style="text-align: center; font-style: italic; color: #666;">
              No completed vaccinations recorded yet
            </td>
          </tr>
          {% endfor %}
          
          <!-- If you want to show scheduled vaccinations separately, add a note -->
          {% if pending_schedules %}
          <tr>
            <td colspan="5" style="background: #f0f8ff; padding: 10px; text-align: center; font-style: italic; color: #1565c0;">
              Additional scheduled vaccinations: {{ pending_schedules|length }} appointment(s) pending
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>

      <p class="modal-note">
        In the column,<strong>Date of Vaccination</strong>, write the date of vaccination according to how many doses has already been administered.<br>
        In the column, <strong>Status</strong>, write the date for the next dose, or any important information that may affect the child's vaccination.
      </p>
    </form>
  </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddScheduleModal()">Ã—</button>
    <h3>Add Vaccination Schedule</h3>
    <form id="addScheduleForm" method="post" action="{% url 'add_schedule' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="vaccineName">Vaccine Name:</label>
        <select id="vaccineName" name="vaccine_name" required onchange="updateRequiredDoses()">
          <option value="" disabled selected>Select Vaccine</option>
          <option value="BCG Vaccine" data-doses="1">BCG Vaccine</option>
          <option value="Hepatitis B Vaccine" data-doses="1">Hepatitis B Vaccine</option>
          <option value="Pentavalent Vaccine" data-doses="3">Pentavalent Vaccine</option>
          <option value="Oral Polio Vaccine" data-doses="4">Oral Polio Vaccine</option>
          <option value="Inactivated Polio Vaccine" data-doses="2">Inactivated Polio Vaccine</option>
          <option value="Pneumococcal Conjugate Vaccine" data-doses="3">Pneumococcal Conjugate Vaccine</option>
          <option value="Measles, Mumps, and Rubella" data-doses="2">Measles, Mumps, and Rubella</option>
        </select>
      </div>

      <input type="hidden" id="requiredDoses" name="required_doses" value="1">
      <input type="hidden" name="vaccine_doses" value="1">
      
      <div class="form-group">
        <label for="immunizationDate">Immunization Date:</label>
        <input type="date" id="immunizationDate" name="immunization_date" required min="2024-01-01">
      </div>
      
      <input type="hidden" name="next_vaccine_schedule" value="">

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save & Notify Parents</button>
        <button type="button" class="btn btn-gray" onclick="closeAddScheduleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Nutrition Service Modal -->
<div id="addNutritionModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddNutritionModal()">Ã—</button>
    <h3>Add Completed Nutrition Service</h3>
    <form id="addNutritionForm" method="post" action="{% url 'add_nutrition_service' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="serviceType">Service Type:</label>
        <select id="serviceType" name="service_type" required>
          <option value="">Select Service</option>
          <option value="Vitamin A">Vitamin A</option>
          <option value="Deworming">Deworming</option>
        </select>
      </div>

      <div class="form-group">
        <label for="completionDate">Date Completed:</label>
        <input type="datetime-local" id="completionDate" name="completion_date" required>
      </div>

      <div class="form-group">
        <label for="notes">Notes (Optional):</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Additional notes about the service..."></textarea>
      </div>

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save</button>
        <button type="button" class="btn btn-gray" onclick="closeAddNutritionModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Vaccine Modal -->
<div id="addVaccineModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeAddVaccineModal()">Ã—</button>
    <h3>Add Completed Vaccine</h3>
    <form id="addVaccineForm" method="post" action="{% url 'add_vaccine' preschooler.preschooler_id %}">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="vaccineNameCompleted">Vaccine Name:</label>
        <select id="vaccineNameCompleted" name="vaccine_name" required onchange="updateCompletedDoses()">
          <option value="">Select Vaccine</option>
          <!-- Smart vaccine options populated by JavaScript -->
        </select>
        <small id="vaccineAgeInfo" style="color: #666; font-size: 12px; margin-top: 5px; display: none;"></small>
      </div>

      <div class="form-group">
        <label for="requiredDosesCompleted">Doses:</label>
        <input type="number" id="requiredDosesCompleted" name="required_doses" min="1" value="1" readonly>
      </div>

      <div class="form-group">
        <label for="immunizationDateCompleted">Date Completed:</label>
        <input type="date" id="immunizationDateCompleted" name="immunization_date" required>
      </div>

      <!-- Removed completion_date field as requested -->

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Save</button>
        <button type="button" class="btn btn-gray" onclick="closeAddVaccineModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Reschedule Modal -->
<div id="rescheduleModal" class="modal-overlay">
  <div class="modal-card schedule-modal-card">
    <button class="close-modal schedule-close-modal" onclick="closeRescheduleModal()">Ã—</button>
    <h3>Reschedule Vaccination</h3>
    <form id="rescheduleForm" method="post" action="{% url 'reschedule_vaccination' %}">
      {% csrf_token %}
      <input type="hidden" id="scheduleId" name="schedule_id">
      
      <div class="form-group">
        <label for="newDate">New Date:</label>
        <input type="date" id="newDate" name="new_date">
      </div>

      <div class="form-group">
        <label for="rescheduleReason">Reason for Rescheduling:</label>
        <textarea id="rescheduleReason" name="reschedule_reason" rows="3" required></textarea>
      </div>

      <div class="schedule-modal-buttons">
        <button type="submit" class="btn btn-green">Reschedule</button>
        <button type="button" class="btn btn-gray" onclick="closeRescheduleModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Set minimum date to tomorrow for scheduling inputs, today for completion inputs
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  const today = new Date().toISOString().split('T')[0];
  
  // Scheduling inputs - require tomorrow or later
  const schedulingInputs = document.querySelectorAll('#immunizationDate, #newDate, #rescheduleNutritionDate, #nutritionServiceDate');
  schedulingInputs.forEach(input => {
    if (input) {
      input.setAttribute('min', tomorrowString);
    }
  });
  
  // Completion inputs - allow today and future
  const completionInputs = document.querySelectorAll('#completionDate, #completionDateCompleted');
  completionInputs.forEach(input => {
    if (input) {
      input.setAttribute('min', today);
    }
  });
  
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) {
          const schedulingInputs = node.querySelectorAll('#immunizationDate, #newDate, #rescheduleNutritionDate, #nutritionServiceDate');
          schedulingInputs.forEach(input => {
            if (!input.hasAttribute('min')) {
              input.setAttribute('min', tomorrowString);
            }
          });
          
          const completionInputs = node.querySelectorAll('#completionDate, #completionDateCompleted');
          completionInputs.forEach(input => {
            if (!input.hasAttribute('min')) {
              input.setAttribute('min', today);
            }
          });
        }
      });
    });
  });
  
  observer.observe(document.body, { childList: true, subtree: true });
});

// Check for Django messages and display them
document.addEventListener('DOMContentLoaded', () => {
  const messages = [
    {% for message in messages %}
    {
      tags: '{{ message.tags }}',
      message: '{{ message|escapejs }}'
    },
    {% endfor %}
  ];

  messages.forEach(msg => {
    if (msg.tags === 'success') {
      Swal.fire({
        title: 'Success!',
        text: msg.message,
        icon: 'success',
        confirmButtonColor: '#4caf50',
        timer: 4000,
        timerProgressBar: true,
        showClass: {
          popup: 'animate__animated animate__fadeInUp'
        }
      });
    } else if (msg.tags === 'error') {
      Swal.fire({
        title: 'Error!',
        text: msg.message,
        icon: 'error',
        confirmButtonColor: '#d32f2f'
      });
    } else if (msg.tags === 'warning') {
      Swal.fire({
        title: 'Warning!',
        text: msg.message,
        icon: 'warning',
        confirmButtonColor: '#ff9800'
      });
    }
  });

  initializeVaccineCardModal();
});

function initializeVaccineCardModal() {
  const form = document.querySelector('#vaccineCardModal form');
  if (!form) return;
  
  const toggleButton = document.createElement('button');
  toggleButton.textContent = 'Edit';
  toggleButton.type = 'button';
  toggleButton.className = 'btn btn-blue';
  const saveBtn = form.querySelector('button[type="submit"]');
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.type = 'button';
  cancelBtn.className = 'btn btn-gray';

  function disableInputs() {
    form.querySelectorAll('.modal-info-grid input[name]').forEach(input => {
      if (input.type !== 'radio') {
        input.setAttribute('readonly', true);
      } else {
        input.setAttribute('disabled', true);
      }
    });
    
    form.querySelectorAll('.vaccine-table input').forEach(input => {
      input.setAttribute('readonly', true);
    });
  }

  function enableInputs() {
    form.querySelectorAll('.modal-info-grid input[name]').forEach(input => {
      if (input.type !== 'radio') {
        input.removeAttribute('readonly');
      } else {
        input.removeAttribute('disabled');
      }
    });
  }

  disableInputs();

  toggleButton.addEventListener('click', () => {
    enableInputs();
    toggleButton.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
  });

  cancelBtn.addEventListener('click', () => {
    location.reload();
  });

  const btnContainer = saveBtn.parentElement;
  btnContainer.insertBefore(toggleButton, saveBtn);
  btnContainer.appendChild(cancelBtn);
  saveBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
}

// Modal functions
function openVaccineCardModal() {
  document.getElementById('vaccineCardModal').style.display = 'flex';
}

function closeVaccineCardModal() {
  document.getElementById('vaccineCardModal').style.display = 'none';
}

function openAddScheduleModal() {
  document.getElementById('addScheduleModal').style.display = 'flex';
}

function closeAddScheduleModal() {
  document.getElementById('addScheduleModal').style.display = 'none';
}

// SMART ADD VACCINE MODAL FUNCTIONS
function populateSmartVaccineDropdown() {
  const select = document.getElementById('vaccineNameCompleted');
  const ageInfo = document.getElementById('vaccineAgeInfo');
  const childAgeMonths = {{ total_age_months }};
  
  // Clear existing options except the first one
  while (select.children.length > 1) {
    select.removeChild(select.lastChild);
  }
  
  // Define vaccines with age requirements and completion status
  const vaccines = [
    {
      name: 'BCG Vaccine',
      doses: 1,
      minAgeMonths: 0,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "BCG Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:1 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Hepatitis B Vaccine',
      doses: 1,
      minAgeMonths: 0,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Hepatitis B Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:1 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Pentavalent Vaccine',
      doses: 3,
      minAgeMonths: 1.5,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Pentavalent Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:3 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Oral Polio Vaccine',
      doses: 3,
      minAgeMonths: 1.5,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Oral Polio Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:3 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Inactivated Polio Vaccine',
      doses: 2,
      minAgeMonths: 3.5,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Inactivated Polio Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:2 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Pneumococcal Conjugate Vaccine',
      doses: 3,
      minAgeMonths: 1.5,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Pneumococcal Conjugate Vaccine" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:3 }}{% endif %}{% empty %}false{% endfor %}
    },
    {
      name: 'Measles, Mumps, and Rubella',
      doses: 2,
      minAgeMonths: 9,
      maxAgeMonths: 60,
      completed: {% for v in vaccine_statuses %}{% if v.name == "Measles, Mumps, and Rubella" %}{{ v.completed_doses|default:0 }} >= {{ v.total_doses|default:2 }}{% endif %}{% empty %}false{% endfor %}
    }
  ];
  
  let availableVaccines = 0;
  
  vaccines.forEach(vaccine => {
    if (vaccine.completed) {
      console.log(`${vaccine.name} is already completed, skipping`);
      return;
    }
    
    if (childAgeMonths >= vaccine.minAgeMonths && childAgeMonths <= vaccine.maxAgeMonths) {
      const option = document.createElement('option');
      option.value = vaccine.name;
      option.setAttribute('data-doses', vaccine.doses);
      option.textContent = vaccine.name;
      select.appendChild(option);
      availableVaccines++;
    }
  });
  
  if (availableVaccines === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No vaccines available for this age/completion status';
    option.disabled = true;
    select.appendChild(option);
    
    ageInfo.textContent = `Child is ${childAgeMonths} months old. All age-appropriate vaccines may already be completed.`;
    ageInfo.style.display = 'block';
    ageInfo.style.color = '#f57c00';
  } else {
    ageInfo.style.display = 'none';
  }
  
  console.log(`Available vaccines for ${childAgeMonths}-month-old child: ${availableVaccines}`);
}

function getCurrentVaccineDoses(vaccineName) {
  const completedDoses = {
    {% for v in vaccine_statuses %}
    '{{ v.name }}': {{ v.completed_doses|default:0 }},
    {% endfor %}
  };
  
  return completedDoses[vaccineName] || 0;
}

function updateCompletedDoses() {
  const select = document.getElementById('vaccineNameCompleted');
  const requiredDosesInput = document.getElementById('requiredDosesCompleted');
  
  // Always set to 1 dose per submission
  requiredDosesInput.value = 1;
  
  const ageInfo = document.getElementById('vaccineAgeInfo');
  const vaccineName = select.options[select.selectedIndex].value;
  
  if (vaccineName) {
    const currentDoses = getCurrentVaccineDoses(vaccineName);
    const nextDose = currentDoses + 1;
    
    ageInfo.textContent = `Adding dose ${nextDose} for ${vaccineName}`;
    ageInfo.style.color = '#2e7d32';
    ageInfo.style.display = 'block';
  }
}

function openAddVaccineModal() {
  document.getElementById('addVaccineModal').style.display = 'flex';
  populateSmartVaccineDropdown();
  
  // Set date constraints for completed vaccines
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('immunizationDateCompleted');
  
  // Allow past dates and today, but NOT future dates
  dateInput.setAttribute('max', today); // Maximum is today
  
  // Minimum date is child's birth date
  const birthDate = '{{ preschooler.birth_date }}';
  dateInput.setAttribute('min', birthDate);
  
  // Clear any existing value
  dateInput.value = '';
  
  console.log(`Date constraints set: min=${birthDate}, max=${today}`);
}

function closeAddVaccineModal() {
  document.getElementById('addVaccineModal').style.display = 'none';
}

function openAddNutritionModal() {
  document.getElementById('addNutritionModal').style.display = 'flex';
}

function closeAddNutritionModal() {
  document.getElementById('addNutritionModal').style.display = 'none';
}

function openRescheduleModal(scheduleId) {
  const button = event.target;
  const row = button.closest('tr');
  const dateCell = row.querySelector('td:nth-child(3)');
  const originalDateText = dateCell.textContent.trim();
  
  let originalDate = null;
  if (originalDateText !== 'N/A' && originalDateText !== '') {
    const parts = originalDateText.split('/');
    if (parts.length === 3) {
      originalDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
    }
  }

  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];

  document.getElementById('rescheduleModal').style.display = 'flex';
  document.getElementById('scheduleId').value = scheduleId;
  
  const dateInput = document.getElementById('newDate');
  dateInput.setAttribute('min', tomorrowString);
  
  dateInput.removeEventListener('change', validateRescheduleDate);
  
  function validateRescheduleDate() {
    const selectedDate = dateInput.value;
    const today = new Date().toISOString().split('T')[0];
    
    if (selectedDate === today) {
      Swal.fire({
        title: 'Invalid Date',
        text: 'Cannot schedule for today. Please select tomorrow or a future date.',
        icon: 'warning',
        confirmButtonColor: '#ff9800',
        confirmButtonText: 'OK'
      });
      dateInput.value = '';
      return;
    }
    
    if (originalDate && selectedDate === originalDate) {
      Swal.fire({
        title: 'Invalid Date',
        text: 'Cannot reschedule to the same original date. Please select a different date.',
        icon: 'warning',
        confirmButtonColor: '#ff9800',
        confirmButtonText: 'OK'
      });
      dateInput.value = '';
      return;
    }
  }
  
  dateInput.addEventListener('change', validateRescheduleDate);
}

function closeRescheduleModal() {
  document.getElementById('rescheduleModal').style.display = 'none';
}

function updateRequiredDoses() {
  const select = document.getElementById('vaccineName');
  const requiredDosesInput = document.getElementById('requiredDoses');
  const selectedOption = select.options[select.selectedIndex];
  const doses = selectedOption.getAttribute('data-doses') || '1';
  requiredDosesInput.value = doses;
}

function scheduleVaccineWithAge(vaccineName, totalDoses, doseNumber, ageDescription) {
  console.log(`Scheduling age-appropriate vaccine: ${vaccineName}, Dose ${doseNumber}`);
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  
  Swal.fire({
    title: `Schedule ${vaccineName}`,
    html: `
        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Date:</label>
        <input type="date" id="ageBasedScheduleDate" class="swal2-input" style="margin: 0;" min="${tomorrowString}">
        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 14px; border-left: 4px solid #2196f3;">
          Parents will receive notifications about this appointment
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Schedule & Notify Parents',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#6c757d',
    preConfirm: () => {
      const date = document.getElementById('ageBasedScheduleDate').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (!date) {
        Swal.showValidationMessage('Please select a date');
        return false;
      }
      
      if (date === today) {
        Swal.showValidationMessage('Cannot schedule for today. Please select tomorrow or a future date.');
        return false;
      }
      
      const selectedDate = new Date(date);
      const tomorrowDate = new Date();
      tomorrowDate.setDate(tomorrowDate.getDate() + 1);
      tomorrowDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < tomorrowDate) {
        Swal.showValidationMessage('Please select tomorrow or a future date');
        return false;
      }
      
      return date;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Scheduling Age-Appropriate Vaccination...',
        html: `
          <div style="margin: 20px 0;">
            <p>Creating schedule for <strong>${vaccineName}</strong></p>
            <p>Dose ${doseNumber} - ${ageDescription}</p>
            <p>Sending notifications to parents...</p>
            <div style="margin-top: 15px;">
              <div class="swal2-loader"></div>
            </div>
          </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false
      });
      
      submitScheduleFormWithDose(vaccineName, totalDoses, result.value, doseNumber, 'age_based_scheduling');
    }
  });
}

function submitScheduleFormWithDose(vaccineName, totalDoses, immunizationDate, doseNumber, source) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/add_schedule/{{ preschooler.preschooler_id }}/`;
  form.style.display = 'none';
  
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
  form.appendChild(csrfInput);
  
  const fields = {
    'vaccine_name': vaccineName,
    'required_doses': totalDoses,
    'vaccine_doses': '1',
    'immunization_date': immunizationDate,
    'current_dose': doseNumber,
    'source': source,
    'age_based': 'true'
  };
  
  Object.keys(fields).forEach(key => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  });
  
  console.log('Submitting age-based schedule form with data:', fields);
  
  document.body.appendChild(form);
  form.submit();
}

document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  
  document.querySelectorAll('.btn-complete').forEach(button => {
    const row = button.closest('tr');
    const dateCell = row.querySelector('td:nth-child(3)');
    
    if (dateCell) {
      const scheduledDateText = dateCell.textContent.trim();
      
      if (scheduledDateText !== 'N/A' && scheduledDateText !== '') {
        const dateParts = scheduledDateText.split('/');
        if (dateParts.length === 3) {
          const scheduledDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
          
          if (scheduledDate > today) {
            button.disabled = true;
            button.style.opacity = '0.5';
            button.style.cursor = 'not-allowed';
            button.title = `Can only be completed on or after ${scheduledDateText}`;
            button.classList.add('btn-disabled-future');
          }
        }
      }
    }
  });
});

function completeCurrentDose(vaccineName, scheduleId, currentDoses, totalDoses) {
  const button = event.target;
  const row = button.closest('tr');
  const dateCell = row.querySelector('td:nth-child(3)');
  const today = new Date().toISOString().split('T')[0];
  
  if (dateCell) {
    const scheduledDateText = dateCell.textContent.trim();
    
    if (scheduledDateText !== 'N/A' && scheduledDateText !== '') {
      const dateParts = scheduledDateText.split('/');
      if (dateParts.length === 3) {
        const scheduledDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
        
        if (scheduledDate > today) {
          Swal.fire({
            title: 'Too Early!',
            html: `
              <div style="margin: 20px 0;">
                <p>This vaccination can only be completed on or after:</p>
                <strong style="color: #1565c0; font-size: 18px;">${scheduledDateText}</strong>
                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 14px; border-left: 4px solid #ffc107;">
                  Please wait until the scheduled date to mark this as completed
                </div>
              </div>
            `,
            icon: 'warning',
            confirmButtonColor: '#ff9800',
            confirmButtonText: 'Understood'
          });
          return;
        }
      }
    }
  }
  
  const nextDose = parseInt(currentDoses) + 1;
  
  Swal.fire({
    title: `Complete ${vaccineName}?`,
    html: `
      <p>This will mark <strong>dose ${nextDose} of ${totalDoses}</strong> as completed.</p>
      <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px;">
        Parents will be notified of completion
      </div>
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#4caf50',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, complete it!'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Completing Dose...',
        text: 'Updating status and notifying parents',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      fetch(`/update_schedule_status/${scheduleId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          status: 'completed'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Dose Completed!',
            text: data.message,
            icon: 'success',
            confirmButtonColor: '#4caf50'
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Error!', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error!', 'Something went wrong.', 'error');
      });
    }
  });
}

function scheduleNextDose(vaccineName, completedDoses, totalDoses) {
  const nextDose = parseInt(completedDoses) + 1;
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  
  Swal.fire({
    title: `Schedule Next Dose`,
    html: `
      <div style="margin: 20px 0;">
        <p><strong>${vaccineName}</strong></p>
        <p>Dose ${nextDose} of ${totalDoses}</p>
        <label style="display: block; margin: 20px 0 10px 0; font-weight: 600;">Select Date:</label>
        <input type="date" id="nextDoseDate" class="swal2-input" style="margin: 0;" min="${tomorrowString}">
        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; font-size: 14px; border-left: 4px solid #2196f3;">
          Parents will receive notifications about this appointment
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Schedule & Notify',
    confirmButtonColor: '#4caf50',
    preConfirm: () => {
      const date = document.getElementById('nextDoseDate').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (!date) {
        Swal.showValidationMessage('Please select a date');
        return false;
      }
      
      if (date === today) {
        Swal.showValidationMessage('Cannot schedule for today. Please select tomorrow or a future date.');
        return false;
      }
      
      const selectedDate = new Date(date);
      const tomorrowDate = new Date();
      tomorrowDate.setDate(tomorrowDate.getDate() + 1);
      tomorrowDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < tomorrowDate) {
        Swal.showValidationMessage('Please select tomorrow or a future date');
        return false;
      }
      
      return date;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Scheduling Next Dose...',
        text: 'Creating schedule and sending notifications',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      submitScheduleForm(vaccineName, totalDoses, result.value, nextDose.toString(), 'next_dose_enhanced');
    } else {
      location.reload();
    }
  });
}

function submitScheduleForm(vaccineName, totalDoses, immunizationDate, currentDose, source) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/add_schedule/{{ preschooler.preschooler_id }}/`;
  form.style.display = 'none';
  
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
  form.appendChild(csrfInput);
  
  const fields = {
    'vaccine_name': vaccineName,
    'required_doses': totalDoses,
    'vaccine_doses': '1',
    'immunization_date': immunizationDate,
    'current_dose': currentDose,
    'source': source
  };
  
  Object.keys(fields).forEach(key => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  });
  
  console.log('Submitting schedule form with data:', fields);
  
  document.body.appendChild(form);
  form.submit();
}

function updateScheduleStatus(scheduleId, status) {
  if (status === 'completed') {
    Swal.fire({
      title: 'Mark as Completed?',
      text: 'This vaccination will be marked as completed.',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#4caf50',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, complete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        submitStatusUpdate(scheduleId, status);
      }
    });
  } else {
    submitStatusUpdate(scheduleId, status);
  }
}

function submitStatusUpdate(scheduleId, status) {
  fetch(`/update_schedule_status/${scheduleId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      status: status
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire('Success!', data.message, 'success').then(() => {
        location.reload();
      });
    } else {
      Swal.fire('Error!', data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    Swal.fire('Error!', 'Something went wrong.', 'error');
  });
}

function scheduleNutritionService(serviceType) {
  console.log(`Scheduling nutrition service: ${serviceType}`);
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  const serviceEmoji = serviceType === "Vitamin A" ? "ðŸ’Š" : "ðŸª±";
  
  Swal.fire({
    title: `${serviceEmoji} Schedule ${serviceType}`,
    html: `
      <div style="margin: 20px 0;">
        <p style="margin-bottom: 15px; color: #333; font-weight: 500;">
          Schedule nutrition service for <strong>${serviceType}</strong>
        </p>
        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Date:</label>
        <input type="date" id="nutritionServiceDate" class="swal2-input" style="margin: 0;" min="${tomorrowString}">
        <div style="margin-top: 15px; padding: 12px; background: #e8f5e8; border-radius: 8px; font-size: 14px; border-left: 4px solid #4caf50;">
          <strong>Parents will receive notifications</strong> about this appointment
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Schedule & Notify Parents',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#6c757d',
    preConfirm: () => {
      const date = document.getElementById('nutritionServiceDate').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (!date) {
        Swal.showValidationMessage('Please select a date');
        return false;
      }
      
      if (date === today) {
        Swal.showValidationMessage('Cannot schedule for today. Please select tomorrow or a future date.');
        return false;
      }
      
      const selectedDate = new Date(date);
      const tomorrowDate = new Date();
      tomorrowDate.setDate(tomorrowDate.getDate() + 1);
      tomorrowDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < tomorrowDate) {
        Swal.showValidationMessage('Please select tomorrow or a future date');
        return false;
      }
      
      return date;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Scheduling Nutrition Service...',
        html: `
          <div style="margin: 20px 0;">
            <p>Creating schedule for <strong>${serviceType}</strong></p>
            <p>Sending notifications to parents...</p>
            <div style="margin-top: 15px;">
              <div class="swal2-loader"></div>
            </div>
          </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false
      });
      
      submitNutritionScheduleForm(serviceType, result.value, 'schedule_nutrition_enhanced');
    }
  });
}

function scheduleNutritionServiceWithAge(serviceType, eligibilityReason) {
  console.log(`Scheduling age-appropriate nutrition service: ${serviceType}`);
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  const serviceEmoji = serviceType === "Vitamin A" ? "ðŸ’Š" : "ðŸª±";
  
  Swal.fire({
    title: `${serviceEmoji} Schedule ${serviceType}`,
    html: `
      <div style="margin: 20px 0;">
        <p style="margin-bottom: 15px; color: #333; font-weight: 500;">
          Schedule nutrition service for <strong>${serviceType}</strong>
        </p>
        <p style="margin-bottom: 15px; font-size: 13px; color: #666;">
          ${eligibilityReason}
        </p>
        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Date:</label>
        <input type="date" id="nutritionServiceDate" class="swal2-input" style="margin: 0;" min="${tomorrowString}">
        <div style="margin-top: 15px; padding: 12px; background: #e8f5e8; border-radius: 8px; font-size: 14px; border-left: 4px solid #4caf50;">
          <strong>Parents will receive notifications</strong> about this appointment
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Schedule & Notify Parents',
    confirmButtonColor: '#28a745',
    cancelButtonColor: '#6c757d',
    preConfirm: () => {
      const date = document.getElementById('nutritionServiceDate').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (!date) {
        Swal.showValidationMessage('Please select a date');
        return false;
      }
      
      if (date === today) {
        Swal.showValidationMessage('Cannot schedule for today. Please select tomorrow or a future date.');
        return false;
      }
      
      const selectedDate = new Date(date);
      const tomorrowDate = new Date();
      tomorrowDate.setDate(tomorrowDate.getDate() + 1);
      tomorrowDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < tomorrowDate) {
        Swal.showValidationMessage('Please select tomorrow or a future date');
        return false;
      }
      
      return date;
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Scheduling Nutrition Service...',
        html: `
          <div style="margin: 20px 0;">
            <p>Creating schedule for <strong>${serviceType}</strong></p>
            <p>Sending notifications to parents...</p>
            <div style="margin-top: 15px;">
              <div class="swal2-loader"></div>
            </div>
          </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false
      });
      
      submitNutritionScheduleForm(serviceType, result.value, 'schedule_nutrition_age_based');
    }
  });
}

function submitNutritionScheduleForm(serviceType, serviceDate, source) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = "{% url 'schedule_nutrition_service' preschooler.preschooler_id %}";
  form.style.display = 'none';
  
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
  form.appendChild(csrfInput);
  
  const fields = {
    'service_type': serviceType,
    'service_date': serviceDate,
    'source': source,
    'notes': `Scheduled via enhanced notification system`
  };
  
  Object.keys(fields).forEach(key => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = fields[key];
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
}

function updateNutritionStatus(scheduleId, status) {
  if (status === 'completed') {
    Swal.fire({
      title: 'Mark Nutrition Service as Completed?',
      html: `
        <p>This nutrition service will be marked as completed.</p>
        <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 14px;">
          Parents will be notified of completion
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, complete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Completing Service...',
          text: 'Updating status and notifying parents',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        submitNutritionStatusUpdate(scheduleId, status);
      }
    });
  } else {
    submitNutritionStatusUpdate(scheduleId, status);
  }
}

function submitNutritionStatusUpdate(scheduleId, status) {
  fetch(`/update_nutrition_status/${scheduleId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      status: status,
      enhanced_notifications: true
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire('Success!', data.message, 'success').then(() => {
        location.reload();
      });
    } else {
      Swal.fire('Error!', data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Nutrition status update error:', error);
    Swal.fire('Error!', 'Something went wrong updating the nutrition service status.', 'error');
  });
}

function openRescheduleNutritionModal(scheduleId) {
  console.log('Opening reschedule modal for nutrition service:', scheduleId);
  
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowString = tomorrow.toISOString().split('T')[0];
  
  Swal.fire({
    title: 'Reschedule Nutrition Service',
    html: `
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600;">New Date:</label>
        <input type="date" id="rescheduleNutritionDate" class="swal2-input" style="margin: 0;" min="${tomorrowString}">
        <label style="display: block; margin: 20px 0 10px 0; font-weight: 600;">Reason for Rescheduling:</label>
        <textarea id="rescheduleNutritionReason" class="swal2-textarea" placeholder="Please provide a reason for rescheduling..."></textarea>
        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
          Parents will be notified about the schedule change
        </div>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Reschedule & Notify',
    confirmButtonColor: '#ff9800',
    cancelButtonColor: '#6c757d',
    preConfirm: () => {
      const newDate = document.getElementById('rescheduleNutritionDate').value;
      const reason = document.getElementById('rescheduleNutritionReason').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (!newDate) {
        Swal.showValidationMessage('Please select a new date');
        return false;
      }
      
      if (newDate === today) {
        Swal.showValidationMessage('Cannot schedule for today. Please select tomorrow or a future date.');
        return false;
      }
      
      if (!reason.trim()) {
        Swal.showValidationMessage('Please provide a reason for rescheduling');
        return false;
      }
      
      const selectedDate = new Date(newDate);
      const tomorrowDate = new Date();
      tomorrowDate.setDate(tomorrowDate.getDate() + 1);
      tomorrowDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < tomorrowDate) {
        Swal.showValidationMessage('Please select tomorrow or a future date');
        return false;
      }
      
      return { newDate, reason };
    }
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'Rescheduling Service...',
        text: 'Updating schedule and notifying parents',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      fetch(`/reschedule_nutrition_service/${scheduleId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
          new_date: result.value.newDate,
          reschedule_reason: result.value.reason,
          enhanced_notifications: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Rescheduled Successfully!',
            text: data.message,
            icon: 'success',
            confirmButtonColor: '#28a745'
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire('Error!', data.message, 'error');
        }
      })
      .catch(error => {
        console.error('Reschedule error:', error);
        Swal.fire('Error!', 'Something went wrong rescheduling the service.', 'error');
      });
    }
  });
}

// Enhanced form validation
document.getElementById('addScheduleForm').addEventListener('submit', function(e) {
  const vaccineSelect = document.getElementById('vaccineName');
  const dateInput = document.getElementById('immunizationDate');
  const today = new Date().toISOString().split('T')[0];
  
  if (!vaccineSelect.value) {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select a vaccine name.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }
  
  if (!dateInput.value) {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select an immunization date.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  if (dateInput.value === today) {
    e.preventDefault();
    Swal.fire({
      title: 'Invalid Date',
      text: 'Cannot schedule for today. Please select tomorrow or a future date.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  const selectedDate = new Date(dateInput.value);
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);
  
  if (selectedDate < tomorrow) {
    e.preventDefault();
    Swal.fire({
      title: 'Invalid Date',
      text: 'Please select tomorrow or a future date for the vaccination.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  Swal.fire({
    title: 'Creating Schedule...',
    text: 'Scheduling vaccination and sending notifications to parents',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  const sourceInput = document.createElement('input');
  sourceInput.type = 'hidden';
  sourceInput.name = 'source';
  sourceInput.value = 'add_schedule_modal';
  this.appendChild(sourceInput);
});

document.getElementById('addNutritionForm').addEventListener('submit', function(e) {
  const serviceSelect = document.getElementById('serviceType');
  const dateInput = document.getElementById('completionDate');
  
  if (!serviceSelect.value) {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select a service type.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }
  
  if (!dateInput.value) {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select a completion date.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  Swal.fire({
    title: 'Adding Nutrition Service...',
    text: 'Recording completion and sending notifications to parents',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  const sourceInput = document.createElement('input');
  sourceInput.type = 'hidden';
  sourceInput.name = 'source';
  sourceInput.value = 'add_nutrition_modal_enhanced';
  this.appendChild(sourceInput);
});

// SMART ADD VACCINE FORM VALIDATION
// FIXED: Add Vaccine Form Validation - Allow past dates, prevent future dates
document.getElementById('addVaccineForm').addEventListener('submit', function(e) {
  const vaccineSelect = document.getElementById('vaccineNameCompleted');
  const dateInput = document.getElementById('immunizationDateCompleted');
  
  // Check if vaccine is selected
  if (!vaccineSelect.value || vaccineSelect.value.trim() === '') {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select a vaccine name.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }
  
  // Check if date is provided
  if (!dateInput.value || dateInput.value.trim() === '') {
    e.preventDefault();
    Swal.fire({
      title: 'Validation Error',
      text: 'Please select the date when the vaccine was completed.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  // Validate date is not in the future
  const selectedDate = new Date(dateInput.value);
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  
  if (selectedDate > today) {
    e.preventDefault();
    Swal.fire({
      title: 'Invalid Date',
      text: 'Completion date cannot be in the future. Please select today or a past date.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  // Validate date is not before child's birth
  const childBirthDate = new Date('{{ preschooler.birth_date }}');
  if (selectedDate < childBirthDate) {
    e.preventDefault();
    Swal.fire({
      title: 'Invalid Date',
      text: 'Completion date cannot be before the child was born.',
      icon: 'warning',
      confirmButtonColor: '#ff9800'
    });
    return;
  }

  // Show loading message
  Swal.fire({
    title: 'Adding Completed Vaccine...',
    text: 'Recording vaccination completion',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  // Add source for tracking
  const sourceInput = document.createElement('input');
  sourceInput.type = 'hidden';
  sourceInput.name = 'source';
  sourceInput.value = 'smart_add_completed_vaccine';
  this.appendChild(sourceInput);
  
  // FIXED: Don't add completion_date - let Django handle the date conversion
  // The immunization_date field already contains the correct date
  
  console.log('Submitting completed vaccine:', {
    vaccine: vaccineSelect.value,
    date: dateInput.value
  });
});

// PDF Generation Function
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  const currentDate = new Date().toLocaleDateString();
  
  pdf.setFontSize(20);
  pdf.setFont(undefined, 'bold');
  pdf.text('CHILD IMMUNIZATION RECORD', 105, 20, { align: 'center' });
  
  pdf.setFontSize(12);
  pdf.setFont(undefined, 'normal');
  pdf.text(`Generated on: ${currentDate}`, 105, 35, { align: 'center' });
  
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'bold');
  pdf.text('CHILD INFORMATION', 20, 50);
  
  pdf.line(20, 52, 190, 52);
  
  pdf.setFontSize(10);
  pdf.setFont(undefined, 'normal');
  
  const childName = '{{ preschooler.first_name }} {{ preschooler.last_name }}';
  const birthDate = '{{ preschooler.birth_date }}';
  const placeOfBirth = '{{ preschooler.place_of_birth|default:"" }}';
  const motherName = '{{ preschooler.parent_id.mother_name|default:"" }}';
  const fatherName = '{{ preschooler.parent_id.father_name|default:"" }}';
  const address = '{{ preschooler.address|default:"" }}';
  const birthWeight = '{{ preschooler.birth_weight|default_if_none:"" }}';
  const birthHeight = '{{ preschooler.birth_height|default_if_none:"" }}';
  const barangay = '{{ preschooler.barangay.name }}';
  const sex = '{{ preschooler.sex }}';
  
  let yPos = 60;
  
  pdf.text(`Child's Name: ${childName}`, 20, yPos);
  pdf.text(`Date of Birth: ${birthDate}`, 110, yPos);
  yPos += 8;
  
  pdf.text(`Place of Birth: ${placeOfBirth}`, 20, yPos);
  pdf.text(`Sex: ${sex}`, 110, yPos);
  yPos += 8;
  
  pdf.text(`Mother's Name: ${motherName}`, 20, yPos);
  pdf.text(`Father's Name: ${fatherName}`, 110, yPos);
  yPos += 8;
  
  const fullAddress = address ? `Address: ${address}` : 'Address:';
  const addressWidth = pdf.getTextWidth(fullAddress);
  
  if (addressWidth <= 170 && fullAddress.length <= 80) {
    pdf.text(fullAddress, 20, yPos);
    yPos += 8;
    pdf.text(`Barangay: ${barangay}`, 20, yPos);
  } else {
    const addressLines = pdf.splitTextToSize(fullAddress, 170);
    addressLines.forEach((line, index) => {
      pdf.text(index === 0 ? line : line.trim(), 20, yPos);
      yPos += 6;
    });
    yPos += 2;
    pdf.text(`Barangay: ${barangay}`, 20, yPos);
  }
  yPos += 8;
  
  pdf.text(`Birth Weight: ${birthWeight} kg`, 20, yPos);
  pdf.text(`Birth Height: ${birthHeight} cm`, 110, yPos);
  yPos += 15;
  
  pdf.setFontSize(14);
  pdf.setFont(undefined, 'bold');
  pdf.text('IMMUNIZATION RECORDS', 20, yPos);
  yPos += 5;
  
  const tableX = 20;
  const tableWidth = 170;
  
  const col1Width = 70;
  const col2Width = 20;
  const col3Width = 25;
  const col4Width = 25;
  const col5Width = 30;
  
  const col1X = tableX;
  const col2X = col1X + col1Width;
  const col3X = col2X + col2Width;
  const col4X = col3X + col3Width;
  const col5X = col4X + col4Width;
  
  pdf.setFillColor(44, 85, 48);
  pdf.rect(tableX, yPos, tableWidth, 8, 'F');
  
  pdf.setTextColor(255, 255, 255);
  pdf.setFontSize(9);
  pdf.setFont(undefined, 'bold');
  
  pdf.text('Vaccine', col1X + 2, yPos + 5);
  pdf.text('Doses', col2X + 2, yPos + 5);
  pdf.text('Date Given', col3X + 2, yPos + 5);
  pdf.text('Status', col4X + 2, yPos + 5);
  pdf.text('Remarks', col5X + 2, yPos + 5);
  
  yPos += 8;
  pdf.setTextColor(0, 0, 0);
  pdf.setFont(undefined, 'normal');
  
  const completedVaccinations = [];
  
  {% for h in immunization_history %}
  {% if h.status == 'completed' %}
  completedVaccinations.push({
    vaccine: '{{ h.vaccine_name }}',
    doses: '{{ h.dose_number|default:1 }}/{{ h.required_doses }}',
    date: '{{ h.completion_date|date:"m/d/Y"|default:"" }}',
    status: 'Completed',
    remarks: '{{ h.medical_remarks|default:"" }}'
  });
  {% endif %}
  {% endfor %}
  
  console.log('Completed vaccinations for PDF:', completedVaccinations.length);
  
  if (completedVaccinations.length === 0) {
    pdf.text('No completed vaccinations recorded yet', col1X + 2, yPos + 4);
    yPos += 10;
  } else {
    completedVaccinations.forEach((record, index) => {
      if (index % 2 === 1) {
        pdf.setFillColor(249, 249, 249);
        pdf.rect(tableX, yPos, tableWidth, 6, 'F');
      }
      
      pdf.setDrawColor(220, 220, 220);
      pdf.line(col2X, yPos, col2X, yPos + 6);
      pdf.line(col3X, yPos, col3X, yPos + 6);
      pdf.line(col4X, yPos, col4X, yPos + 6);
      pdf.line(col5X, yPos, col5X, yPos + 6);
      
      let vaccineName = record.vaccine;
      
      const maxVaccineWidth = col1Width - 4;
      if (pdf.getTextWidth(vaccineName) > maxVaccineWidth) {
        const vaccineLines = pdf.splitTextToSize(vaccineName, maxVaccineWidth);
        if (vaccineLines.length > 1) {
          vaccineName = vaccineLines[0].trim();
          if (vaccineName.length > 30) {
            vaccineName = vaccineName.substring(0, 27) + '...';
          }
        }
      }
      
      pdf.text(vaccineName, col1X + 2, yPos + 4);
      pdf.text(record.doses, col2X + 2, yPos + 4);
      pdf.text(record.date, col3X + 2, yPos + 4);
      pdf.text(record.status, col4X + 2, yPos + 4);
      
      let remarks = record.remarks || '';
      if (remarks.length > 15) {
        remarks = remarks.substring(0, 12) + '...';
      }
      pdf.text(remarks, col5X + 2, yPos + 4);
      
      yPos += 6;
      
      if (yPos > 270) {
        pdf.addPage();
        yPos = 20;
      }
    });
  }
  
  yPos += 20;
  if (yPos > 270) {
    pdf.addPage();
    yPos = 20;
  }
  
  pdf.setFontSize(8);
  pdf.setFont(undefined, 'italic');
  pdf.text('This official record contains ONLY completed immunizations.', 105, yPos, { align: 'center' });
  pdf.text('Scheduled appointments are not included until completion.', 105, yPos + 5, { align: 'center' });
  
  const fileName = `${childName.replace(/\s+/g, '_')}_Completed_Immunizations.pdf`;
  pdf.save(fileName);
  
  Swal.fire({
    title: 'PDF Generated!',
    text: 'Official immunization record saved (completed vaccinations only).',
    icon: 'success',
    confirmButtonColor: '#4caf50'
  });
}

function setCompletionDateConstraints() {
  const today = new Date().toISOString().split('T')[0];
  const birthDate = '{{ preschooler.birth_date }}';
  
  // For completed vaccines - allow past dates and today
  const completedDateInputs = document.querySelectorAll('#immunizationDateCompleted');
  completedDateInputs.forEach(input => {
    if (input) {
      input.setAttribute('max', today);  // No future dates
      input.setAttribute('min', birthDate); // No dates before birth
      
      // Add helpful placeholder
      input.setAttribute('placeholder', 'Select completion date');
    }
  });
}

// Auto-populate when page loads
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('immunizationDateCompleted');
  
  if (dateInput) {
    dateInput.addEventListener('change', function() {
      const selectedDate = new Date(this.value);
      const today = new Date();
      const childBirthDate = new Date('{{ preschooler.birth_date }}');
      
      // Clear any previous validation styling
      this.style.borderColor = '';
      
      if (selectedDate > today) {
        this.style.borderColor = '#d32f2f';
        this.title = 'Date cannot be in the future';
      } else if (selectedDate < childBirthDate) {
        this.style.borderColor = '#d32f2f';
        this.title = 'Date cannot be before child was born';
      } else {
        this.style.borderColor = '#4caf50';
        this.title = 'Valid completion date';
      }
    });
  }
});

console.log('Age-based vaccine scheduling loaded for child age: {{ total_age_months }} months');
console.log('Vaccine scheduling will now check child age eligibility');
</script>


<script>
  // ============================================
  // ARCHIVED PRESCHOOLER READ-ONLY ENFORCEMENT
  // ============================================
  document.addEventListener('DOMContentLoaded', function() {
    const isArchived = {{ is_archived|yesno:"true,false" }};
    
    if (isArchived) {
      console.log('Archived preschooler detected - Enabling read-only mode');
      
      // 1. DISABLE ALL ACTION BUTTONS (except vaccine card + back/close)
      disableAllButtons();
      
      // 2. DISABLE ALL FORM INPUTS
      disableAllInputs();
      
      // 3. PREVENT FORM SUBMISSIONS
      preventFormSubmissions();
      
      // 4. DISABLE MODAL ACTIONS (except vaccine card)
      disableModalActions();
      
      // 5. OVERRIDE BUTTON CLICK HANDLERS
      overrideButtonHandlers();
      
      // 6. MAKE VACCINE CARD VIEW-ONLY
      disableVaccineCardEditing();
    }
  });

  function disableAllButtons() {
    // Disable schedule/action buttons
    document.querySelectorAll(
      '.add-schedule-btn, .add-nutrition-btn, .btn-schedule, .btn-complete, .btn-reschedule'
    ).forEach(btn => {
      btn.disabled = true;
      btn.classList.add('archived-disabled');
      btn.title = 'Cannot modify archived preschooler';
      btn.style.pointerEvents = 'none';
    });

    // âœ… Do not disable "View Vaccine Card"
    // âœ… Do not disable back-button or close-modal buttons
  }

  function disableAllInputs() {
    document.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(field => {
      field.disabled = true;
      field.readOnly = true;
      field.classList.add('archived-input');
    });
  }

  function preventFormSubmissions() {
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      });
    });
  }

  function disableModalActions() {
    const modalFunctions = [
      'openAddScheduleModal',
      'openAddVaccineModal',
      'openAddNutritionModal',
      'openRescheduleModal',
      'openRescheduleNutritionModal'
      // âœ… leave openVaccineCardModal working
    ];
    
    modalFunctions.forEach(funcName => {
      if (typeof window[funcName] === 'function') {
        window[funcName] = function() {
          return false; // silently block
        };
      }
    });
  }

  function overrideButtonHandlers() {
    const actionFunctions = [
      'scheduleVaccineWithAge',
      'scheduleNutritionService',
      'scheduleNutritionServiceWithAge',
      'completeCurrentDose',
      'updateScheduleStatus',
      'updateNutritionStatus',
      'scheduleNextDose'
    ];
    
   
  }

  function disableVaccineCardEditing() {
    const vaccineModal = document.getElementById('vaccineCardModal');
    if (vaccineModal) {
      const form = vaccineModal.querySelector('form');
      if (form) {
        form.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(field => {
          field.disabled = true;
          field.readOnly = true;
          field.classList.add('archived-input');
        });
        
        // Hide edit/save buttons
        form.querySelectorAll('button[type="submit"], button.btn-green, button.btn-blue').forEach(btn => {
          btn.style.display = 'none';
        });
      }
    }
  }

  // âœ… Removed all Swal "Action Not Allowed" notifs
  // âœ… Allow back-button & close-modal
  // âœ… Allow view vaccine card to open normally

 


  console.log('Archived preschooler read-only mode:', {{ is_archived|yesno:"true,false" }});
</script>
<script>
function goBack() {
  // Get the referrer parameter from URL if it exists
  const urlParams = new URLSearchParams(window.location.search);
  const from = urlParams.get('from');
  
  // If there's a 'from' parameter, use it
  if (from === 'archived') {
    location.href = '/archived';
  } else if (from === 'registered') {
    location.href = '/preschoolers';
  } else {
    // Fallback: use browser history or default to preschoolers
    if (document.referrer && (document.referrer.includes('/archived') || document.referrer.includes('/preschoolers'))) {
      window.history.back();
    } else {
      location.href = '/preschoolers';
    }
  }
}
</script>

</body>
</html>



