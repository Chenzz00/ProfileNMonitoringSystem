  <!DOCTYPE html>
  <html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register Parent</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'media/PPMS-logo.png' %}">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        min-height: 100vh;
        margin: 0;
        overflow-x: hidden;
        font-size: 14px;
        font-weight: 400;
        background: #f8f9fa;
      }

      .background-image {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-image: url('{% static "media/loginbg.png" %}');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }

      /* Sidebar Navigation */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        background: linear-gradient(180deg, #1e1e2f 0%, #2a2a3e 100%);
        z-index: 1000;
        transition: transform 0.3s ease;
        overflow-y: auto;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 25px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        flex-shrink: 0;
      }

      .sidebar-title {
        color: #fff;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.5px;
        margin: 0;
      }

      .sidebar-profile {
        padding: 20px 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        color: white;
        flex-shrink: 0;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .sidebar-profile:hover {
        background-color: rgba(91, 218, 179, 0.1);
      }

      .profile-image {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .profile-info h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: white;
      }

      .profile-info p {
        margin: 2px 0 0 0;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
      }

      .nav-menu {
        padding: 20px 0 0 0;
        display: flex;
        flex-direction: column;
        height: calc(100% - 140px);
        flex: 1;
      }

      .nav-item {
        margin: 0;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 16px 25px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        background: none;
        width: 100%;
        cursor: pointer;
        position: relative;
      }

      .nav-link:hover {
        background: rgba(91, 218, 179, 0.1);
        color: #5bdab3;
        padding-left: 30px;
      }

      .nav-link.active {
        background: rgba(91, 218, 179, 0.2);
        color: #5bdab3;
        border-right: 3px solid #5bdab3;
      }

      .nav-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        opacity: 0.8;
      }

      .nav-link:hover .nav-icon {
        opacity: 1;
      }

      .logout-nav-item {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: auto;
      }

      .logout-nav-item .nav-link {
        color: #ff6b6b;
      }

      .logout-nav-item .nav-link:hover {
        background-color: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
      }

      /* Main Content Area */
      .main-content {
        margin-left: 280px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
        width: calc(100% - 280px);
      }

      .topbar {
        background-color: rgba(30, 30, 47, 0.95);
        backdrop-filter: blur(10px);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .top-icons {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .greeting {
        font-size: 20px;
        font-weight: 500;
        color: #fff;
        margin: 0;
      }

      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.3s ease;
        position: relative;
      }

      .icon-btn:hover {
        animation: shake 500ms ease-in-out;
        color: #5bdab3;
      }

      @keyframes shake {
        0% { rotate: 0deg }
        25% { rotate: 25deg }
        50% { rotate: -25deg }
        75% { rotate: 25deg }
        100% { rotate: 10deg }
      }

      .mobile-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
      }

      .notif-dropdown {
        position: relative;
        display: inline-block;
      }
      
      #notifMenu {
        display: none;
        position: absolute;
        right: -10px;
        top: calc(100% + 8px);
        background-color: #fff;
        min-width: 320px;
        max-width: 350px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        z-index: 1000;
        border-radius: 12px;
        padding: 12px;
        border: 1px solid #e0e4e7;
      }

      #notifMenu .dropdown-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        text-decoration: none;
        display: block;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: background-color 0.2s ease;
      }

      #notifMenu .dropdown-item:hover {
        background-color: #f8f9fa;
      }

      #notifDot {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 10px;
        height: 10px;
        background-color: #ff4444;
        border-radius: 50%;
        display: none;
        border: 2px solid #1e1e2f;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .sidebar-overlay.active {
        display: block;
      }

      /* Content Wrapper - FIXED STYLING */
      .content-wrapper {
        padding: 30px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: calc(100vh - 80px);
      }

      .form-box {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
      }

      .form-box h2 { 
        margin-bottom: 25px; 
        text-align: center; 
        color: #333; 
        font-size: 20px; 
        font-weight: 500; 
        letter-spacing: 1px; 
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section h3 {
        color: #333;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 1px solid #e6e6e6;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-group { 
        margin-bottom: 0; 
      }
      
      .form-group label { 
        display: block; 
        font-weight: 500; 
        margin-bottom: 8px; 
        color: #333; 
        font-size: 14px; 
      }
      
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #e6e6e6;
        font-size: 14px;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        background-color: white;
        color: #333;
        font-weight: 400;
      }
      
      .form-group input:focus,
      .form-group select:focus { 
        outline: none; 
        border-color: #5bdab3; 
        box-shadow: 0 0 0 3px rgba(91, 218, 179, 0.15); 
        background-color: white; 
      }
      
      .form-group input:hover,
      .form-group select:hover { 
        border-color: #5bdab3; 
        background-color: white; 
      }

      .form-group select {
        cursor: pointer;
      }

      .btn {
        display: inline-block;
        background-color: #5bdab3;
        color: #1e1e2f;
        padding: 14px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: center;
        box-shadow: 0 2px 6px rgba(91, 218, 179, 0.3);
        margin-top: 15px;
      }
      
      .btn:hover { 
        background-color: #1565c0; 
        color: white; 
        transform: translateY(-2px); 
        box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3); 
      }
      
      .btn:active { 
        transform: translateY(0); 
      }

      /* Mobile Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 260px;
        }
        
        .main-content {
          margin-left: 260px;
          width: calc(100% - 260px);
        }

        .form-row {
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 15px;
        }
        
        .content-wrapper {
          padding: 25px;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
          width: 100%;
          max-width: 100%;
        }

        .mobile-toggle {
          display: block;
        }

        .topbar {
          padding: 15px 20px;
        }

        .greeting {
          font-size: 18px;
        }

        .content-wrapper {
          padding: 20px 15px;
        }

        .form-box {
          padding: 25px;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        #notifMenu {
          right: -20px;
          left: auto;
          min-width: 280px;
          max-width: calc(100vw - 40px);
          margin-right: 10px;
        }
      }

      @media (max-width: 480px) {
        .content-wrapper {
          padding: 15px 10px;
        }

        .form-box {
          padding: 15px;
        }
      }

      @media (max-width: 360px) {
        .greeting {
          font-size: 14px;
        }
        
        .sidebar-title {
          font-size: 16px;
        }
        
        .nav-link {
          padding: 14px 20px;
          font-size: 13px;
        }

        .form-box {
          padding: 12px;
        }
      }

      /* SweetAlert2 styling */
      .custom-swal-popup { 
        font-family: 'Poppins', sans-serif; 
        border-radius: 12px; 
        padding: 20px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
      }
      
      .custom-swal-title { 
        font-weight: 600; 
        font-size: 20px; 
        color: #333; 
        margin-bottom: 15px; 
        text-align: center; 
      }
      
      .custom-swal-text { 
        font-weight: 400; 
        font-size: 14px; 
        color: #666; 
        line-height: 1.6; 
        text-align: center; 
      }
      
      .custom-swal-button { 
        font-weight: 500; 
        font-size: 14px; 
        padding: 12px 30px; 
        border-radius: 8px; 
        border: none; 
        margin-top: 10px; 
      }
      
      .custom-swal-button:hover { 
        transform: translateY(-1px); 
        box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
      }
      
      .custom-swal-success .custom-swal-button { 
        background-color: #28a745; 
        color: white; 
      }
      
      .custom-swal-error .custom-swal-button { 
        background-color: #dc3545; 
        color: white; 
      }

      .success-credentials { 
        background-color: #f8f9fa; 
        border: 1px solid #e9ecef; 
        border-radius: 8px; 
        padding: 15px; 
        margin: 10px 0; 
        text-align: left; 
      }
      
      .success-credentials strong { 
        color: #28a745; 
      }
    </style>
  </head>
  <body>
    <div class="background-image"></div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Left Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title">PPMS {{ account.barangay.name }}</h1>
      </div>
      
      <!-- Profile Section in Sidebar -->
      <div class="sidebar-profile" onclick="location.href='{% url 'profile' %}'">
        {% if account.profile_photo and account.profile_photo.image %}
          <img src="{{ account.profile_photo.image.url }}" alt="Profile" class="profile-image">
        {% else %}
          <img src="{% static 'media/default-profile.jpg' %}" alt="Default Profile" class="profile-image">
        {% endif %}
        <div class="profile-info">
          <h3>{{ account.first_name }} {{ account.last_name }}</h3>
          <p>{{ account.barangay.name }}</p>
        </div>
      </div>
      
      <nav class="nav-menu">
        <div class="nav-item">
          <a href="{% url 'dashboard' %}" class="nav-link">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Dashboard
          </a>
        </div>
        
        <div class="nav-item">
          <a href="{% url 'register_parent' %}" class="nav-link active">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
            </svg>
            Register Parent
          </a>
        </div>
        
        <div class="nav-item">
          <a href="{% url 'register_preschooler' %}" class="nav-link">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
            </svg>
            Register Preschooler
          </a>
        </div>
        
        <div class="nav-item">
          <a href="{% url 'email_endorsement' %}" class="nav-link">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
              <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
            </svg>
            Email Endorsement
          </a>
        </div>
        
        <div class="nav-item">
          <a href="{% url 'history' %}" class="nav-link">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
            </svg>
            View Parent Logs
          </a>
        </div>

        <div class="nav-item">
          <button class="nav-link" id="nutritionReportBtn">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Nutrition Report
          </button>
        </div>
        
        <div class="nav-item">
          <button class="nav-link" id="immunizationReportBtn">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
            Immunization Report
          </button>
        </div>
        
        <!-- Logout at bottom of navigation -->
        <div class="nav-item logout-nav-item">
          <button class="nav-link" id="logoutLink">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
            </svg>
            Logout
          </button>
        </div>
      </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="topbar">
        <div style="display: flex; align-items: center; gap: 15px;">
          <button class="mobile-toggle" id="mobileToggle">☰</button>
          <div class="greeting">PPMS CLUSTER 4 IMUS CITY</div>
        </div>
        <div class="top-icons">
          <!-- Notification -->
          <div class="notif-dropdown">
            <button class="icon-btn" id="notifBtn" style="position: relative;">
              <img src="{% static 'media/notification.png' %}" alt="Notifications" style="width: 2.5rem; height: 2.5rem;">
              <span id="notifDot"></span>
            </button>

            <div class="dropdown" id="notifMenu" style="max-height: 400px; overflow-y: auto; width: 320px; min-width: 280px;">
              {% if notifications %}
                {% for notif in notifications %}
                  {% if notif.type == 'account' %}
                    <a href="{% url 'register_preschooler' %}" class="dropdown-item notif-item" data-id="{{ notif.id }}" data-type="account" style="display: flex; flex-direction: column; gap: 2px;">
                      <div style="display: flex; align-items: center;">
                        <img src="{% static 'media/default-profile.jpg' %}" alt="Default" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px;">
                        <span class="notif-text">
                          New Registered
                          {% if notif.user_role|lower == "parent" %}
                            <strong>Parent</strong>
                          {% else %}
                            <strong>{{ notif.user_role }}</strong>
                          {% endif %}
                          account named <strong>{{ notif.full_name }}</strong>.
                        </span>
                      </div>
                      <small style="margin-left: 40px; color: gray;">{{ notif.timestamp|timesince }} ago</small>
                    </a>
                  {% endif %}
                {% endfor %}
              {% else %}
                <div class="dropdown-item">No notifications available.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Content Wrapper - PROPERLY STRUCTURED -->
      <div class="content-wrapper">
        <div class="form-box">
          <h2>Register Parent</h2>
          <form method="POST" action="" id="registerForm">
            {% csrf_token %}

            <div class="form-section">
            <h3>Personal Information</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
              </div>
              <div class="form-group">
                <label for="middleName">Middle Name</label>
                <input type="text" id="middleName" name="middleName">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="suffix">Suffix (Optional)</label>
                <input type="text" id="suffix" name="suffix" placeholder="e.g., Jr., Sr., III"> 
              </div>
            </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                  <label for="contact_number">Contact Number</label>
                  <input type="text" id="contact_number" name="contact_number"
                        required maxlength="11" minlength="11" pattern="\d{11}"
                        onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                        onpaste="return false"
                        title="Please enter exactly 11 digits">
                </div>
              </div>

              <div class="form-row">
    <div class="form-group">
      <label for="birthdate">Birthdate</label>
      <input type="date" id="birthdate" name="birthdate" required>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="sex">Sex</label>
      <select id="sex" name="sex" required>
        <option value="" disabled selected>Select Sex</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
    </div>
  </div>



            <div class="form-section">
              <h3>
                Address <small class="text-muted" style="font-size: 0.75rem;">*If not applicable, put NA</small>
              </h3>
              <div class="form-row">
                <div class="form-group">
                  <label for="houseNumber">House Number</label>
                  <input type="text" id="houseNumber" name="houseNumber" placeholder="Enter House Number" required>
                </div>
                <div class="form-group">
                  <label for="block">Block</label>
                  <input type="text" id="block" name="block" placeholder="Enter Block" required>
                </div>
                <div class="form-group">
                  <label for="lot">Lot</label>
                  <input type="text" id="lot" name="lot" placeholder="Enter Lot" required>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="phase">Phase</label>
                  <input type="text" id="phase" name="phase" placeholder="Enter Phase">
                </div>
                <div class="form-group">
                  <label for="street">Street</label>
                  <input type="text" id="street" name="street" placeholder="Enter Street" required>
                </div>
                <div class="form-group">
                  <label for="subdivision">Subdivision (Optional)</label>
                  <input type="text" id="subdivision" name="subdivision" placeholder="Enter Subdivision">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" name="city" placeholder="Enter City" required>
                </div>
                <div class="form-group">
                  <label for="province">Province</label>
                  <input type="text" id="province" name="province" placeholder="Enter Province" required>
                </div>
              </div>
            </div>

            <button type="submit" class="btn">Register Parent</button>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Mobile sidebar toggle
      function initializeMobileToggle() {
        const mobileToggle = document.getElementById("mobileToggle");
        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");

        if (mobileToggle) {
          mobileToggle.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            sidebarOverlay.classList.toggle("active");
          });

          sidebarOverlay.addEventListener("click", () => {
            sidebar.classList.remove("open");
            sidebarOverlay.classList.remove("active");
          });
        }
      }

      // Initialize Notifications
      function initializeNotifications() {
        const notifBtn = document.getElementById("notifBtn");
        const notifMenu = document.getElementById("notifMenu");
        const notifDot = document.getElementById("notifDot");

        const latestNotifTimestampStr = "{{ latest_notif_timestamp|default:'' }}";
        const latestNotifTimestamp = latestNotifTimestampStr ? new Date(latestNotifTimestampStr) : null;
        const lastReadStr = localStorage.getItem("lastReadNotifTimestamp");
        const lastRead = lastReadStr ? new Date(lastReadStr) : null;

        if (latestNotifTimestamp && (!lastRead || latestNotifTimestamp > lastRead)) {
          notifDot.style.display = "inline-block";
        }

        if (notifBtn && notifMenu) {
          notifBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            notifMenu.style.display = notifMenu.style.display === "block" ? "none" : "block";
            notifDot.style.display = "none";
            if (latestNotifTimestamp) {
              localStorage.setItem('lastReadNotifTimestamp', latestNotifTimestamp.toISOString());
            }
          });

          document.addEventListener("click", (e) => {
            if (!e.target.closest(".notif-dropdown")) {
              notifMenu.style.display = "none";
            }
          });
        }
      }

      // Initialize Event Listeners
      function initializeEventListeners() {
        // Logout confirmation
        document.getElementById("logoutLink")?.addEventListener("click", function(e) {
          e.preventDefault();
          Swal.fire({
            title: 'Are you sure you want to logout?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3498db',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Yes, logout',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = "/logout/";
            }
          });
        });

        // Nutrition Report
        document.getElementById("nutritionReportBtn")?.addEventListener("click", function(e) {
          e.preventDefault();
          Swal.fire({
            title: 'Select Month for Nutrition Report',
            input: 'month',
            showCancelButton: true,
            confirmButtonColor: '#3498db',
            cancelButtonColor: '#aaa',
            confirmButtonText: 'Download Excel',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
              if (!value) {
                return 'Please select a month first!';
              }
            }
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({
                title: 'Generating Report...',
                text: 'Please wait while we prepare your Excel file.',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });

              const downloadUrl = "/generate-nutrition-excel/?month=" + result.value;
              
              const link = document.createElement('a');
              link.href = downloadUrl;
              link.download = 'nutrition-report.xlsx';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

              setTimeout(() => {
                Swal.fire({
                  title: 'Download Started!',
                  text: 'Your nutrition report Excel file is being downloaded.',
                  icon: 'success',
                  timer: 3000,
                  showConfirmButton: false
                });
              }, 2000);
            }
          });
        });

        // Immunization Report
        document.getElementById("immunizationReportBtn")?.addEventListener("click", function(e) {
          e.preventDefault();
          Swal.fire({
            title: 'Select Month for Immunization Report',
            input: 'month',
            showCancelButton: true,
            confirmButtonColor: '#3498db',
            cancelButtonColor: '#95a5a6',
            confirmButtonText: 'Generate Report',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
              if (!value) {
                return 'Please select a month first!';
              }
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const url = "{% url 'generate_immunization_report' %}?month=" + result.value;
              window.open(url, "_blank");
            }
          });
        });
      }

      // Form validation and handling
      document.addEventListener('DOMContentLoaded', () => {
        initializeMobileToggle();
        initializeNotifications();
        initializeEventListeners();

        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const email = document.getElementById('email');
        const contact = document.getElementById('contact_number');
        const birthdate = document.getElementById('birthdate');
        const houseNumber = document.getElementById('houseNumber');
        const block = document.getElementById('block');
        const lot = document.getElementById('lot');
        const phase = document.getElementById('phase');
        const street = document.getElementById('street');
        const city = document.getElementById('city');
        const province = document.getElementById('province');
        const subdivision = document.getElementById('subdivision');
        const form = document.getElementById('registerForm');

        // Set max date to today
        birthdate.max = new Date().toISOString().split("T")[0];

        // Name field validation
        [firstName, lastName, suffix].forEach(input => input.addEventListener('input', e => {
          e.target.value = e.target.value.replace(/[^a-zA-Z\s.,]/g, '').replace(/^\s+|\s{2,}/g, ' ');
        }));

        // Address field validation including subdivision
        [street, city, province, subdivision].forEach(input => {
          input.addEventListener('input', e => {
            e.target.value = e.target.value
              .replace(/[^a-zA-Z0-9\s.,#/-]/g, '') 
              .replace(/^\s+|\s{2,}/g, ' ');       
          });

          // Capitalize "n/a" on blur
          input.addEventListener('blur', e => {
            if (e.target.value.trim().toLowerCase() === 'n/a') {
              e.target.value = 'N/A';
            }
          });
        });

        // House/Block/Lot/Phase field validation - NUMBERS ONLY (and NA)
        [houseNumber, block, lot, phase].forEach(input => {
          input.addEventListener('input', e => {
            // Allow only numbers and "NA" (case insensitive)
            let value = e.target.value.toUpperCase();
            
            // If user is typing "NA", allow it
            if (value === 'N' || value === 'NA') {
              e.target.value = value;
            } else {
              // Otherwise, only allow numbers
              e.target.value = e.target.value.replace(/[^0-9]/g, '');
            }
          });

          // Handle "na" conversion on blur - only convert to "NA" (not "N/A")
          input.addEventListener('blur', e => {
            if (e.target.value.trim().toLowerCase() === 'n' || 
                e.target.value.trim().toLowerCase() === 'na') {
              e.target.value = 'NA';
            }
          });
        });

        // Email and contact validation
        email.addEventListener('input', e => e.target.value = e.target.value.replace(/\s/g, ''));
        contact.addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11));

        // Form submission validation
        form.addEventListener('submit', e => {
          if (firstName.value.trim() === '' || lastName.value.trim() === '') {
            e.preventDefault();
            Swal.fire({ 
              icon:'error', 
              title:'Invalid Name', 
              text:'First and Last name cannot be spaces only.', 
              confirmButtonColor:'#dc3545', 
              customClass:{
                popup:'custom-swal-popup custom-swal-error', 
                title:'custom-swal-title', 
                htmlContainer:'custom-swal-text', 
                confirmButton:'custom-swal-button'
              }
            });
            return;
          }
          if (birthdate.value && new Date(birthdate.value) > new Date()) {
            e.preventDefault();
            Swal.fire({ 
              icon:'error', 
              title:'Invalid Birthdate', 
              text:'Birthdate cannot be in the future.', 
              confirmButtonColor:'#dc3545', 
              customClass:{
                popup:'custom-swal-popup custom-swal-error', 
                title:'custom-swal-title', 
                htmlContainer:'custom-swal-text', 
                confirmButton:'custom-swal-button'
              }
            });
            return;
          }
          if (contact.value.length !== 11 || !/^\d{11}$/.test(contact.value)) {
            e.preventDefault();
            Swal.fire({ 
              icon:'error', 
              title:'Invalid Contact', 
              text:'Contact number must be exactly 11 digits.', 
              confirmButtonColor:'#dc3545', 
              customClass:{
                popup:'custom-swal-popup custom-swal-error', 
                title:'custom-swal-title', 
                htmlContainer:'custom-swal-text', 
                confirmButton:'custom-swal-button'
              }
            });
            return;
          }
        });
      });

      // Django messages handling
      {% if messages %}
      document.addEventListener("DOMContentLoaded", () => {
        {% for message in messages %}
          const isSuccess = '{{ message.tags }}' === 'success';
          const messageText = `{{ message|escapejs }}`;
          let formattedMessage = messageText;
          
          if (isSuccess && messageText.includes('Email:') && messageText.includes('Password:')) {
            const lines = messageText.split('\n');
            let credentialsHtml = '';
            let regularText = '';
            lines.forEach(line => {
              if (line.includes('Email:') || line.includes('Password:')) {
                credentialsHtml += `<div style="margin: 5px 0;"><strong>${line}</strong></div>`;
              } else if (line.trim()) {
                regularText += line + '<br>';
              }
            });
            if (credentialsHtml) {
              formattedMessage = `<div style="margin-bottom: 15px;">${regularText}</div>
                                  <div class="success-credentials">
                                    <div style="margin-bottom: 10px; font-weight: 500; color: #28a745;">Login Credentials:</div>
                                    ${credentialsHtml}
                                    <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">Please save these credentials securely.</div>
                                  </div>`;
            }
          }
          
          Swal.fire({
            icon: isSuccess ? 'success' : 'error',
            title: isSuccess ? 'Registration Successful!' : 'Registration Failed',
            html: `<div style="white-space: pre-line; text-align: center; font-family: 'Poppins', sans-serif; line-height: 1.5;">${formattedMessage}</div>`,
            confirmButtonColor: isSuccess ? '#28a745' : '#dc3545',
            confirmButtonText: 'OK',
            width: '450px',
            customClass: { 
              popup: `custom-swal-popup ${isSuccess ? 'custom-swal-success' : 'custom-swal-error'}`, 
              title: 'custom-swal-title', 
              htmlContainer: 'custom-swal-text', 
              confirmButton: 'custom-swal-button' 
            }
          });
        {% endfor %}
      });
      {% endif %}
    </script>


    <script>
document.addEventListener('DOMContentLoaded', function () {

  const textIds = [
    'firstName', 'middleName', 'lastName', 'suffix',
    'street', 'subdivision', 'city', 'province'
  ];

 
  const numericOrNAIds = ['houseNumber', 'block', 'lot', 'phase'];


  function resetInput(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    
    const clone = el.cloneNode(true);
   
    if (clone.hasAttribute('pattern')) clone.removeAttribute('pattern');
    el.parentNode.replaceChild(clone, el);
    return clone;
  }

 
  const allowedTextRegex = /[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s\.'\-.,#\/]/g;


  textIds.forEach(id => {
    const input = resetInput(id);
    if (!input) return;

    input.addEventListener('input', function (e) {
      // remove disallowed characters
      const cleaned = e.target.value.replace(allowedTextRegex, '');
      // prevent leading/trailing multiple spaces
      e.target.value = cleaned.replace(/^\s+/, '').replace(/\s{2,}/g, ' ');
    });

    input.addEventListener('blur', function (e) {
      // Trim and collapse spaces on blur
      e.target.value = e.target.value.trim().replace(/\s{2,}/g, ' ');
      // Capitalize N/A if entered
      if (e.target.value.trim().toLowerCase() === 'n/a') e.target.value = 'N/A';
    });
  });

  // Attach handlers for numeric-or-NA fields
  numericOrNAIds.forEach(id => {
    const input = resetInput(id);
    if (!input) return;

    // Remove pattern attribute if exists
    if (input.hasAttribute('pattern')) input.removeAttribute('pattern');

    input.addEventListener('input', function (e) {
      let v = e.target.value.toUpperCase();
      if (v === 'N' || v === 'NA') {
        e.target.value = v;
        return;
      }
      // allow only digits
      e.target.value = v.replace(/[^0-9]/g, '');
    });

    input.addEventListener('blur', function (e) {
      const v = e.target.value.trim().toLowerCase();
      if (v === 'n' || v === 'na') e.target.value = 'NA';
    });
  });

 
  const contact = resetInput('contact_number');
  if (contact) {
    contact.addEventListener('input', function (e) {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
    });
  }


  const birthdate = document.getElementById('birthdate');
  if (birthdate) birthdate.max = new Date().toISOString().split('T')[0];

  
});
</script>


  </body>
  </html>




